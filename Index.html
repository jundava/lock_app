<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lock - Gesti√≥n de Obras</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
    /* --- VARIABLES GLOBALES --- */
    :root {
      --color-base: #556B2F;
      --color-base-dark: #3e4f22;
      --header-height: 60px;
      --sidebar-width: 260px;
      --sidebar-width-collapsed: 80px; /* Ancho reducido para el sidebar colapsado */
      --bottom-nav-height: 70px;

      /* Dimensiones de Logo */
      --navbar-logo-height: 96px;
      --login-logo-height: 96px;
    }

    body {
      background-color: #f4f6f8;
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      overflow-x: hidden;
      margin: 0;
    }

    /* --- CLASES UTILITARIAS --- */
    .bg-expert {
      background-color: var(--color-base) !important;
      color: white;
    }

    .text-expert {
      color: var(--color-base) !important;
    }

    .btn-expert {
      background-color: var(--color-base);
      color: white;
      border: none;
    }

    .btn-expert:hover {
      background-color: var(--color-base-dark);
      color: white;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* --- 1. PANTALLA DE LOGIN (Mejorada) --- */
    .login-container {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, #6d8541 0%, #2c3e16 100%);
    }

    .login-card {
      width: 100%;
      max-width: 380px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      padding: 2.5rem;
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--color-base);
    }

    .login-logo-img {
      height: var(--login-logo-height);
      width: auto;
      object-fit: contain;
      margin-bottom: 1rem;
    }

    /* --- 2. NAVBAR SUPERIOR (Global) --- */
    .top-navbar {
      height: var(--header-height);
      background-color: var(--color-base);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1030;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Grupo Logo + Texto en Navbar */
    .navbar-brand-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .navbar-logo-img {
      height: var(--navbar-logo-height);
      width: auto;
      object-fit: contain;
      /* Filtro para volver el logo BLANCO PURO */
      filter: brightness(0) invert(1) drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }

    .navbar-brand-text {
      color: white;
      font-weight: 700;
      font-size: 1.3rem;
      letter-spacing: -0.5px;
      line-height: 1;
    }
    
    /* Bot√≥n de toggle en Navbar */
    .btn-toggle-sidebar {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 40px; 
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      margin-right: 15px;
      cursor: pointer;
    }
    .btn-toggle-sidebar:hover {
      background: rgba(255,255,255,0.3);
    }


    /* --- 3. SIDEBAR (Desktop) --- */
    .sidebar {
      width: var(--sidebar-width);
      position: fixed;
      top: var(--header-height);
      bottom: 0;
      left: 0;
      background: white;
      border-right: 1px solid #e0e0e0;
      padding-top: 1rem;
      z-index: 1020;
      transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Transici√≥n suave */
    }
    
    /* Clases para el estado Colapsado */
    .sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
    }

    /* Ocultar textos y subt√≠tulos cuando est√° colapsado */
    .sidebar.collapsed .nav-link-custom span,
    .sidebar.collapsed .sidebar-header-text,
    .sidebar.collapsed .small.text-uppercase {
      display: none;
    }

    /* Centrar iconos cuando est√° colapsado */
    .sidebar.collapsed .nav-link-custom {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }

    .sidebar.collapsed .nav-link-custom i {
      margin-right: 0;
      font-size: 1.5rem; /* Iconos un poco m√°s grandes */
    }

    /* Ajuste del footer del sidebar */
    .sidebar.collapsed .border-top div {
      justify-content: center;
    }
    .sidebar.collapsed .border-top div .text-muted {
      display: none;
    }


    .nav-link-custom {
      display: flex;
      align-items: center;
      padding: 12px 24px;
      color: #555;
      text-decoration: none;
      font-weight: 500;
      border-left: 4px solid transparent;
      transition: all 0.2s;
    }

    .nav-link-custom:hover {
      background-color: #f8f9fa;
      color: var(--color-base);
    }

    .nav-link-custom.active {
      background-color: rgba(85, 107, 47, 0.1);
      color: var(--color-base);
      border-left-color: var(--color-base);
    }

    .nav-link-custom i {
      font-size: 1.2rem;
      margin-right: 12px;
    }

    /* --- 4. CONTENIDO PRINCIPAL --- */
    .main-wrapper {
      margin-top: var(--header-height);
      margin-left: var(--sidebar-width);
      /* Margen para Desktop */
      padding: 2rem;
      min-height: calc(100vh - var(--header-height));
      transition: margin-left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Transici√≥n suave */
    }
    
    .main-wrapper.collapsed {
      margin-left: var(--sidebar-width-collapsed);
    }


    /* --- 5. BOTTOM NAVIGATION (M√≥vil) --- */
    .bottom-nav {
      display: none;
      /* Oculto en PC */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--bottom-nav-height);
      background: white;
      box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.08);
      z-index: 1040;
      justify-content: space-around;
      align-items: center;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #adb5bd;
      text-decoration: none;
      font-size: 0.7rem;
      width: 100%;
      height: 100%;
      transition: color 0.2s;
    }

    .bottom-nav-item i {
      font-size: 1.4rem;
      margin-bottom: 2px;
    }

    .bottom-nav-item.active {
      color: var(--color-base);
      font-weight: 700;
    }

    /* --- RESPONSIVE LOGIC --- */
    @media (max-width: 768px) {
      .sidebar {
        display: none !important;
      }

      /* Ocultar Sidebar */
      .main-wrapper {
        margin-left: 0 !important; /* Forzar margen 0 en m√≥vil */
        padding: 1rem;
        padding-bottom: 90px;
      }

      /* Quitar margen y dar espacio abajo */
      .bottom-nav {
        display: flex !important;
      }

      /* Mostrar Bottom Nav */
      .navbar-brand-text {
        display: none;
      }
      
      /* Ocultar bot√≥n toggle en m√≥vil si no se usa */
      .btn-toggle-sidebar {
        display: none !important;
      }

      /* Ocultar texto Lock en m√≥vil para ahorrar espacio si se quiere, o dejarlo */
      .top-navbar {
        padding: 0 1rem;
      }
    }

    /* Loader */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(2px);
    }

    /* Estilos para Maestro-Detalle */
    .bg-expert-light {
      background-color: rgba(85, 107, 47, 0.1) !important;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    .transition-effect {
      transition: all 0.2s ease;
    }

    .border-dashed {
      border-style: dashed !important;
    }

    /* Scrollbar fino para la lista de tareas */
    .overflow-auto::-webkit-scrollbar {
      width: 6px;
    }

    .overflow-auto::-webkit-scrollbar-thumb {
      background-color: #ccc;
      border-radius: 4px;
    }

    .hover-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .hover-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    /* Estilos para los botones de acci√≥n sutiles */
    .hover-danger:hover {
        background-color: #dc354520 !important; /* Rojo suave */
        color: #dc3545 !important;
    }
    .hover-warning:hover {
        background-color: #ffc10720 !important; /* Amarillo suave */
        color: #d6a100 !important;
    }
    .hover-primary:hover {
        background-color: #0d6efd20 !important; /* Azul suave */
        color: #0d6efd !important;
    }

    /* Ajuste fino para la tarjeta */
    .project-card .card-title {
        font-size: 1.1rem;
        letter-spacing: -0.3px;
    }

    /* Estilos adicionales para Reportes */
    .btn-outline-expert {
      color: var(--color-base);
      border-color: var(--color-base);
    }

    .btn-outline-expert:hover,
    .btn-outline-expert.active,
    .btn-check:checked + .btn-outline-expert {
      background-color: var(--color-base);
      color: white;
      border-color: var(--color-base);
    }

    .btn-outline-expert:focus {
      box-shadow: 0 0 0 0.2rem rgba(85, 107, 47, 0.25);
    }

    /* Responsive para controles de ordenamiento */
    @media (max-width: 768px) {
      .card-body .col-md-8 .d-flex {
        flex-direction: column;
        gap: 0.5rem !important;
      }
      
      .card-body .col-md-8 .btn-group {
        width: 100%;
      }
      
      .card-body .col-md-8 .btn-group .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
    }

    /* Animaci√≥n para el acorde√≥n de reportes */
    #reportAccordion {
      transition: all 0.3s ease-in-out;
    }

    .accordion-item {
      transition: transform 0.2s ease;
    }

    .accordion-button:not(.collapsed) {
      background-color: rgba(85, 107, 47, 0.05);
      color: var(--color-base);
    }

    /* --- ESTILOS GANTT CHART --- */
.gantt-container {
  overflow-x: auto;
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  position: relative;
}

.gantt-header {
  display: flex;
  background-color: #f8f9fa;
  border-bottom: 1px solid #ddd;
  position: sticky;
  top: 0;
  z-index: 10;
}

.gantt-header-cell {
  flex-shrink: 0;
  border-right: 1px solid #eee;
  padding: 8px;
  text-align: center;
  font-size: 0.75rem;
  font-weight: bold;
  color: #666;
  background: #f8f9fa;
}

.gantt-body {
  position: relative;
  min-height: 200px;
}

.gantt-row {
  display: flex;
  align-items: center;
  border-bottom: 1px solid #f0f0f0;
  height: 45px; /* Altura de fila */
  position: relative;
}

.gantt-row:hover {
  background-color: #fafafa;
}

/* Columna lateral fija (Nombre proyecto) */
.gantt-sidebar-item {
  position: sticky;
  left: 0;
  background: white;
  z-index: 5;
  width: 200px; /* Ancho fijo nombre */
  padding: 0 10px;
  border-right: 2px solid #e0e0e0;
  display: flex;
  align-items: center;
  height: 45px;
  box-shadow: 2px 0 5px rgba(0,0,0,0.05);
}

.gantt-timeline-wrapper {
  flex-grow: 1;
  position: relative;
  height: 100%;
}

/* L√≠neas verticales de fondo */
.gantt-grid-lines {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  pointer-events: none;
}

.gantt-grid-line {
  border-right: 1px dashed #eee;
  flex-shrink: 0;
  height: 100%;
}

/* La barra del proyecto */
.gantt-bar {
  position: absolute;
  top: 10px; /* Centrado verticalmente (45px altura - 25px barra) / 2 */
  height: 25px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  overflow: hidden;
  white-space: nowrap;
}

.gantt-bar:hover {
  transform: translateY(-1px);
  filter: brightness(0.95);
  z-index: 20; /* Que sobresalga al hover */
}

/* Barra de progreso interna */
.gantt-bar-progress {
  height: 100%;
  background-color: rgba(255,255,255,0.3);
  position: absolute;
  left: 0;
  top: 0;
}

.gantt-bar-label {
  position: sticky;
  left: 5px;
  font-size: 0.7rem;
  color: white;
  padding-left: 5px;
  font-weight: bold;
  text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  z-index: 2;
}

  </style>
</head>

<body>
  <div id="app">
    <div v-if="!isLoggedIn" class="login-container">
      <div class="login-card text-center fade-in">
        <h3 class="fw-bold text-dark mb-1">Bienvenido a Lock</h3>
        <p class="text-muted small mb-4">Gesti√≥n Integral de Proyectos</p>
        <div v-if="userEmail"
          class="alert alert-light border border-success text-success py-2 px-3 small rounded-pill mb-4 d-inline-flex align-items-center shadow-sm">
          <i class="bi bi-person-check-fill me-2"></i> {{ userEmail }}
        </div>
        <button class="btn btn-expert w-100 py-2 rounded-3 shadow fw-bold" @click="login">
          Ingresar al Sistema
        </button>
        <div class="mt-4 pt-3 border-top">
          <small class="text-muted" style="font-size: 0.7rem;">v2.2.0 &bull; Expert Ë∞∑ËÑá Ê∑≥ - Enterprise Edition</small>
        </div>
      </div>
    </div>

    <div v-else>
      <div v-if="loading" class="loading-overlay">
          <div class="spinner-border text-expert" role="status"></div>
      </div>

      <div v-if="!loading && !isAuthorized" class="d-flex align-items-center justify-content-center vh-100 bg-light fade-in">
          <div class="text-center p-5 bg-white shadow rounded" style="max-width: 500px;">
              <div class="text-danger mb-3">
                <i class="bi bi-shield-lock-fill" style="font-size: 4rem;"></i>
              </div>
              <h2 class="fw-bold text-dark">Acceso Restringido</h2>
              <p class="text-muted my-3">
                El correo no tiene permisos para acceder a esta aplicaci√≥n.
              </p>
              <div class="alert alert-warning small text-start shadow-sm border-0">
                <i class="bi bi-info-circle-fill me-2"></i>
                Tu cuenta de Google es v√°lida, pero no figuras en la lista de <b>Profesionales Autorizados</b>
              </div>
              <div class="d-grid gap-2 mt-4">
                  <button class="btn btn-outline-secondary" @click="logout">
                    <i class="bi bi-box-arrow-left me-2"></i> Cerrar Sesi√≥n
                  </button>
              </div>
              <div class="mt-3 text-muted small">
                  Contacte al administrador del sistema.
              </div>
          </div>
      </div>

    <div v-if="!loading && isAuthorized" class="fade-in">
      <nav class="top-navbar">
        <div class="navbar-brand-group">
          <button class="btn-toggle-sidebar d-none d-md-flex" @click="toggleSidebar">
              <i class="bi" :class="isSidebarCollapsed ? 'bi-list' : 'bi-text-indent-right'"></i>
          </button>
          <img src="https://drive.google.com/thumbnail?id=19JlPNv17CWp8RnF1bdiA7C25K2G17U11&sz=w1000" alt="Lock Logo"
            class="navbar-logo-img">
          <span class="navbar-brand-text d-none d-md-block"></span>
          <span class="navbar-brand-text d-md-none ms-2"></span>
        </div>
        <div class="dropdown">
          <a href="#" class="d-flex align-items-center text-decoration-none dropdown-toggle text-dark" data-bs-toggle="dropdown">
            
            <div class="rounded-circle bg-expert text-white d-flex align-items-center justify-content-center me-2 shadow-sm border border-2 border-white"
                style="width: 35px; height: 35px; font-weight: bold;">
              {{ userInitial }}
            </div>
            
            <div class="d-none d-sm-block text-start" style="line-height: 1.2;">
                <div class="fw-bold text-white" style="font-size: 0.85rem;">
                    {{ currentUserProfile ? currentUserProfile.nombre : 'Usuario' }}
                </div>
                <div class="text-white" style="font-size: 0.7rem;">
                    {{ userEmail }}
                </div>
            </div>

          </a>
          <ul class="dropdown-menu dropdown-menu-end shadow border-0">
            <li><a class="dropdown-item text-danger" href="#" @click="logout"><i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesi√≥n</a></li>
          </ul>
        </div>
      </nav>

      <aside class="sidebar" :class="{ collapsed: isSidebarCollapsed }">
        <nav class="d-flex flex-column h-100">
          <div class="px-3 mb-2 small text-muted text-uppercase fw-bold" 
              style="font-size: 0.75rem; white-space: nowrap;">
              Navegaci√≥n
          </div>

          <a href="#" class="nav-link-custom" :class="{ active: currentView === 'dashboard' }" @click.prevent="navigate('dashboard')">
            <i class="bi bi-grid-1x2-fill"></i>
            
            <span>Inicio</span>
          </a>
          <a href="#" class="nav-link-custom" :class="{ active: currentView === 'projects' }" @click.prevent="navigate('projects')">
            <i class="bi bi-building-fill-gear"></i> 
            <span>Proyectos</span>
          </a>
          <a href="#" class="nav-link-custom" :class="{ active: currentView === 'reports' }" 
            @click.prevent="navigate('reports')"
            v-if="currentUserProfile && currentUserProfile.rol_sistema === 'Admin'">
            <i class="bi bi-file-earmark-bar-graph"></i> 
            <span>Reportes</span>
          </a>
          <a href="#" class="nav-link-custom" :class="{ active: currentView === 'config' }" @click.prevent="navigate('config')"
            v-if="currentUserProfile && currentUserProfile.rol_sistema === 'Admin'"> <i class="bi bi-sliders"></i> 
            <span>Configuraci√≥n</span>
          </a>

          <div class="mt-auto p-3 border-top bg-light">
            <div class="d-flex align-items-center small">
              <i class="bi bi-shield-check text-success fs-5"></i> <div class="text-muted lh-1 ms-2"> <strong>Sistema Seguro</strong><br>
                <span style="font-size: 0.7rem;">Conectado a Google Drive</span>
              </div>
            </div>
          </div>
        </nav>
      </aside>

      <main class="main-wrapper" :class="{ collapsed: isSidebarCollapsed }">
        <div v-if="currentView === 'config'" class="fade-in">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">Configuraci√≥n</h4>
          </div>
          <div class="card border-0 shadow-sm overflow-hidden">
            <div class="card-header bg-white p-0 border-bottom">
              <ul class="nav nav-tabs nav-fill border-0" id="configTabs">
                <li class="nav-item"><button class="nav-link rounded-0 py-3 active" data-bs-toggle="tab"
                    data-bs-target="#tab-general">General</button></li>
                <li class="nav-item"><button class="nav-link rounded-0 py-3" data-bs-toggle="tab"
                    data-bs-target="#tab-profesionales">Equipo</button></li>                    
                <li class="nav-item"><button class="nav-link rounded-0 py-3" data-bs-toggle="tab"
                    data-bs-target="#tab-tipos">Tipos</button></li>  
                <li class="nav-item"><button class="nav-link rounded-0 py-3" data-bs-toggle="tab"
                    data-bs-target="#tab-checklists">Protocolos</button></li>                                      
                <li class="nav-item"><button class="nav-link rounded-0 py-3" data-bs-toggle="tab"
                    data-bs-target="#tab-etapas">Etapas</button></li>
              </ul>
            </div>
            <div class="card-body bg-light">
              <div class="tab-content">
                <div class="tab-pane fade show active" id="tab-general">
                  <div class="bg-white p-4 rounded shadow-sm">
                    <label class="form-label fw-bold">Repositorio Drive (URL)</label>
                    <div class="input-group">
                      <input type="text" v-model="config.driveUrl" class="form-control"
                        placeholder="https://drive.google.com...">
                      <button class="btn btn-expert" @click="saveDriveUrl">Guardar</button>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="tab-tipos">
                  <div class="bg-white rounded shadow-sm">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                      <h6 class="mb-0 fw-bold"><i class="bi bi-diagram-2 me-2"></i>Tipos de Proyecto</h6>
                      <button class="btn btn-sm btn-expert rounded-pill px-3" @click="openModal('tipo')">
                        <i class="bi bi-plus-lg"></i> Nuevo Tipo
                      </button>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="table-light small">
                          <tr>
                            <th class="ps-4">Nombre</th>
                            <th>Descripci√≥n</th>
                            <th class="text-end pe-4">Acci√≥n</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="t in tipos" :key="t.id">
                            <td class="ps-4">
                              <span class="badge rounded-pill me-2" :style="{backgroundColor: t.color_representativo || '#555'}">&nbsp;</span>
                              <strong>{{ t.nombre_tipo }}</strong>
                            </td>
                            <td class="small text-muted">{{ t.descripcion }}</td>
                            <td class="text-end pe-4">
                              <button class="btn btn-sm btn-link text-expert p-1" @click="openModal('tipo', t)"
                                title="Editar">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button class="btn btn-sm btn-link text-danger" @click="deleteRecord('CONF_TIPO_PROYECTO', t.id)">
                                <i class="bi bi-trash"></i>
                              </button>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade" id="tab-etapas">
                  <div class="row h-100 fade-in">
                    <div class="col-md-6 mb-3">
                      <div class="bg-white rounded shadow-sm h-100 d-flex flex-column">
                        
                        <div class="p-3 border-bottom bg-light">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold text-expert"><i class="bi bi-list-ol me-2"></i>Ciclo de Vida</h6>
                            <button class="btn btn-sm btn-expert rounded-pill px-3 shadow-sm" @click="openModal('etapa')">
                              <i class="bi bi-plus-lg"></i> Etapa
                            </button>
                          </div>
                          
                          <div class="input-group input-group-sm">
                            <select class="form-select border-start-0 bg-white shadow-none text-dark fw-bold" 
                                    v-model="selectedTipoConfig" 
                                    @change="selectedEtapa = null">
                              <option :value="null" disabled>-- Selecciona --</option>
                              <option v-for="t in tipos" :key="t.id" :value="t.id">{{ t.nombre_tipo }}</option>
                            </select>
                          </div>
                        </div>

                        <div class="table-responsive flex-grow-1" style="min-height: 300px; max-height: 500px; overflow-y: auto;">
                          <div v-if="etapasFiltradasPorTipo.length === 0" class="text-center py-5 text-muted">
                              <small>No hay etapas para este tipo.</small>
                          </div>
                          <table v-else class="table table-hover align-middle mb-0">
                            <thead class="table-light small sticky-top">
                              <tr>
                                <th class="ps-3" style="width: 50px;">#</th>
                                <th>Etapas</th>
                                <th class="text-end pe-3" style="width: 50px;"></th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="e in etapasFiltradasPorTipo" :key="e.id" @click="selectEtapa(e)"
                                class="cursor-pointer transition-effect"
                                :class="{'bg-expert-light border-start border-4 border-expert': selectedEtapa && selectedEtapa.id === e.id}">
                                
                                <td class="ps-3">
                                  <span class="badge bg-white text-secondary border shadow-sm">{{e.orden}}</span>
                                </td>
                                
                                <td class="py-2">
                                  <div class="d-flex align-items-center">
                                    <div class="rounded-circle me-2 flex-shrink-0" 
                                          :style="{width:'8px', height:'8px', backgroundColor: e.color_hex}"></div>
                                    <div>
                                        <div class="lh-1" :class="{'fw-bold text-expert': selectedEtapa && selectedEtapa.id === e.id}">
                                          {{e.nombre_etapa}}
                                        </div>
                                        <div v-if="e.descripcion" class="text-muted" style="font-size: 0.7rem; max-width: 400px;">
                                          {{ e.descripcion }}
                                        </div>
                                    </div>
                                  </div>
                                </td>
                                
                                <td class="text-end pe-3">
                                  <button class="btn btn-sm text-danger p-0 opacity-50 hover-opacity-100" 
                                          @click.stop="deleteRecord('CONF_ETAPAS', e.id)" title="Eliminar etapa">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <div class="col-md-6 mb-3">
                      <div class="bg-white rounded shadow-sm h-100 d-flex flex-column position-relative overflow-hidden border">
                        <div v-if="!selectedEtapa" class="d-flex flex-column align-items-center justify-content-center h-100 text-muted p-5 text-center bg-light">
                          <i class="bi bi-arrow-left-circle display-4 mb-3 opacity-25"></i>
                          <h6>Selecciona una Etapa</h6>
                          <p class="small text-muted">Haz clic en la lista izquierda para ver sus tareas.</p>
                        </div>
                        
                        <div v-else class="d-flex flex-column h-100 fade-in">
                          <div class="p-3 border-bottom bg-expert text-white d-flex justify-content-between align-items-center shadow-sm" style="z-index: 2;">
                            <div class="overflow-hidden">
                              <small class="opacity-75 d-block text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Configurando Tareas</small>
                              <h6 class="mb-0 fw-bold text-truncate">{{ selectedEtapa.nombre_etapa }}</h6>
                            </div>
                            <span class="badge bg-white text-expert shadow-sm">{{ tareasFiltradasLength }} Tareas</span>
                          </div>
                          
                          <div class="flex-grow-1 p-3 overflow-auto bg-light" style="max-height: 400px;">
                            <div v-for="(t, index) in tareasFiltradas" :key="index" class="card border-0 shadow-sm mb-2 bg-white">
                                <div class="card-body p-2">
                                  <div class="d-flex align-items-center mb-2">
                                    <span class="text-muted small me-2">{{ index + 1 }}.</span>
                                    <div class="flex-grow-1">
                                      <input type="text" v-model="t.nombre_tarea" 
                                            class="form-control form-control-sm border-0 bg-light fw-bold" 
                                            placeholder="Nombre de la tarea...">
                                    </div>
                                    <div class="form-check form-switch ms-2">
                                      <input class="form-check-input" type="checkbox" :id="'chk'+index" v-model="t.requiere_evidencia">
                                      <label class="small text-muted cursor-pointer" :for="'chk'+index" title="Requiere subir archivo">Evidencia</label>
                                    </div>
                                    <button class="btn btn-sm text-danger ms-1" @click="removeTareaLocal(index,t.id)">
                                      <i class="bi bi-x"></i>
                                    </button>
                                  </div>
                                  <div class="row g-1 px-2 pb-1">
                                    <div class="col-6">
                                      <select v-model="t.tipo_entrada" class="form-select form-select-sm border-0 bg-light small text-muted">
                                          <option value="text">Input Texto</option>
                                          <option value="textarea">√Årea de Texto</option>
                                      </select>
                                    </div>
                                    <div class="col-6">
                                      <select v-model="t.checklist_id" class="form-select form-select-sm border-0 bg-light small text-muted">
                                          <option value="">Sin Protocolo</option>
                                          <option v-for="cl in checklists" :key="cl.id" :value="cl.id">üìã {{ cl.nombre_checklist }}</option>
                                      </select>
                                    </div>
                                  </div>
                                </div>
                            </div>
                            <button class="btn btn-outline-expert w-100 mb-2 border-dashed mt-3 opacity-75 hover-opacity-100" @click="addTareaLocal">
                              <i class="bi bi-plus-circle me-1"></i> Nueva Tarea
                            </button>
                          </div>
                          
                          <div class="p-3 border-top bg-white mt-auto z-1">
                            <button class="btn btn-expert w-100 shadow-sm rounded-pill" @click="saveTareasBatch" :disabled="loading">
                              <i class="bi bi-save me-2"></i> Guardar Tareas
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="tab-profesionales">
                  <div class="bg-white rounded shadow-sm">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center flex-wrap gap-2">
                      <div class="d-flex align-items-center">
                        <h6 class="mb-0 fw-bold me-3">Equipo de Trabajo</h6>
                        <div class="btn-group btn-group-sm">
                          <input type="radio" class="btn-check" name="statusFilter" id="showAll" autocomplete="off"
                            checked @click="filterStatus = 'all'">
                          <label class="btn btn-outline-secondary" for="showAll">Todos</label>
                          <input type="radio" class="btn-check" name="statusFilter" id="showActive" autocomplete="off"
                            @click="filterStatus = 'Activo'">
                          <label class="btn btn-outline-secondary" for="showActive">Activos</label>
                        </div>
                      </div>
                      <button class="btn btn-sm btn-expert rounded-pill px-3 shadow-sm"
                        @click="openModal('profesional')">
                        <i class="bi bi-person-plus-fill me-1"></i> Nuevo Miembro
                      </button>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="table-light small text-muted text-uppercase">
                          <tr>
                            <th class="ps-3">Profesional</th>
                            <th>Rol / Especialidad</th>
                            <th>Contacto</th>
                            <th>Perfil</th>
                            <th class="text-center">Estado</th>
                            <th class="text-end pe-3">Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="p in profesionalesFiltrados" :key="p.id">
                            <td class="ps-3">
                              <div class="d-flex align-items-center">
                                <div
                                  class="rounded-circle bg-light text-expert d-flex align-items-center justify-content-center fw-bold me-3 border"
                                  style="width: 40px; height: 40px; font-size: 0.9rem;">
                                  {{ p.nombre_completo.charAt(0).toUpperCase() }}
                                </div>
                                <div>
                                  <div class="fw-bold text-dark">{{ p.nombre_completo }}</div>
                                  <div class="small text-muted" style="font-size: 0.75rem;">ID: ...{{ p.id.substr(-4) }}
                                  </div>
                                </div>
                              </div>
                            </td>
                            <td>
                              <span
                                class="badge bg-expert bg-opacity-10 text-white border border-expert border-opacity-25 mb-1">
                                {{ p.rol || 'Sin Rol' }}
                              </span>
                              <div class="small text-muted">{{ p.especialidad }}</div>
                            </td>
                            <td>
                              <div class="d-flex flex-column small">
                                <span v-if="p.email"><i class="bi bi-envelope me-1 text-muted"></i> {{ p.email }}</span>
                                <span v-if="p.telefono"><i class="bi bi-whatsapp me-1 text-success"></i> {{ p.telefono
                                  }}</span>
                              </div>
                            </td>
                            <td>
                              <span class="fw-bold text-dark">{{ p.perfil_sistema }}</span>
                            </td>
                            <td class="text-center">
                              <span class="badge rounded-pill"
                                :class="p.estado === 'Activo' ? 'bg-success' : 'bg-secondary'">
                                {{ p.estado || 'Activo' }}
                              </span>
                            </td>
                            <td class="text-end pe-3">
                              <button class="btn btn-sm btn-link text-expert p-1" @click="openModal('profesional', p)"
                                title="Editar">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button v-if="p.estado === 'Activo'" class="btn btn-sm btn-link text-warning p-1"
                                @click="toggleStatus(p)" title="Desactivar">
                                <i class="bi bi-pause-circle"></i>
                              </button>
                              <button v-else class="btn btn-sm btn-link text-danger p-1"
                                @click="deleteRecord('CONF_PROFESIONALES', p.id)" title="Eliminar Definitivamente">
                                <i class="bi bi-trash"></i>
                              </button>
                            </td>
                          </tr>
                          <tr v-if="profesionalesFiltrados.length === 0">
                            <td colspan="6" class="text-center py-5 text-muted">
                              <i class="bi bi-people display-4 opacity-25"></i>
                              <p class="mt-2">No se encontraron profesionales con este criterio.</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="tab-checklists">
                  <div class="bg-white rounded shadow-sm">
                    <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-0 fw-bold">Protocolos de Calidad</h6>
                        <small class="text-muted">Define las listas de verificaci√≥n para cada etapa.</small>
                      </div>
                      <button class="btn btn-sm btn-expert rounded-pill px-3 shadow-sm" @click="openModal('checklist')">
                        <i class="bi bi-ui-checks me-1"></i> Nuevo Protocolo
                      </button>
                    </div>
                    <div class="table-responsive">
                      <table class="table table-hover align-middle mb-0">
                        <thead class="table-light small text-muted text-uppercase">
                          <tr>
                            <th class="ps-4">Nombre</th>
                            <th>Complejidad</th>
                            <th>√öltima Edici√≥n</th>
                            <th class="text-end pe-4">Acciones</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="c in checklists" :key="c.id">
                            <td class="ps-4">
                              <div class="d-flex align-items-center">
                                <div class="bg-light text-expert rounded p-2 me-3 border">
                                  <i class="bi bi-clipboard-check fs-5"></i>
                                </div>
                                <strong>{{ c.nombre_checklist }}</strong>
                              </div>
                            </td>
                            <td>
                              <span class="badge bg-secondary bg-opacity-10 text-secondary border">
                                {{ getChecklistCount(c.config_json) }} Puntos de control
                              </span>
                            </td>
                            <td class="small text-muted">
                              {{ new Date(c.created_at).toLocaleDateString() }}
                            </td>
                            <td class="text-end pe-4">
                              <button class="btn btn-sm btn-link text-expert p-1" @click="openModal('checklist', c)"
                                title="Editar estructura">
                                <i class="bi bi-pencil-square"></i>
                              </button>
                              <button class="btn btn-sm btn-link text-danger p-1"
                                @click="deleteRecord('CONF_CHECKLISTS', c.id)" title="Eliminar">
                                <i class="bi bi-trash"></i>
                              </button>
                            </td>
                          </tr>
                          <tr v-if="checklists.length === 0">
                            <td colspan="4" class="text-center py-5 text-muted">
                              <i class="bi bi-clipboard-x display-4 opacity-25"></i>
                              <p class="mt-2">No hay checklists configurados.</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'dashboard'" class="container-fluid fade-in">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold" style="color: #556B2F;">
                    <i class="bi bi-speedometer2 me-2"></i>Panel de Control
                </h3>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h2 class="fw-bold display-5" style="color: #556B2F;">
                                {{ proyectosFiltradosBuscador.length }}
                            </h2>
                            <div class="text-muted small text-uppercase fw-bold ls-1">Proyectos Activos</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h2 class="fw-bold display-5 text-primary">
                                {{ dashTotalTareas }}
                            </h2>
                            <div class="text-muted small text-uppercase fw-bold ls-1">Tareas Totales</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h2 class="fw-bold display-5 text-success">
                                {{ dashTareasCompletadas }}
                            </h2>
                            <div class="text-muted small text-uppercase fw-bold ls-1">Tareas Completadas</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h2 class="fw-bold display-5 text-warning">
                                {{ Math.round(dashAvancePromedio) }}%
                            </h2>
                            <div class="text-muted small text-uppercase fw-bold ls-1">Avance Global</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'projects'" class="fade-in">
          <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <div>
              <h4 class="fw-bold mb-0 text-dark">Proyectos</h4>
              <small class="text-muted">Gesti√≥n Operativa</small>
            </div>
            <div class="d-flex gap-2">
              <div class="input-group input-group-sm shadow-sm" style="width: 300px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" v-model="searchQuery" class="form-control border-start-0" placeholder="Buscar proyectos...">
              </div>
              <button class="btn btn-expert d-flex align-items-center shadow-sm" 
                      @click="openModal('proyecto')"
                      v-if="currentUserProfile && currentUserProfile.rol_sistema === 'Admin'"> <i class="bi bi-plus-lg me-2"></i> Nuevo Proyecto
              </button>
            </div>
          </div>
          <div v-if="proyectos.length === 0" class="text-center py-5 border rounded bg-white shadow-sm">
            <div class="mb-3 text-muted opacity-50"><i class="bi bi-building-add" style="font-size: 4rem;"></i></div>
            <h5>No tienes proyectos registrados</h5>
            <p class="text-muted small">Crea el primero para comenzar a gestionar tareas y evidencias.</p>
            <button class="btn btn-outline-expert btn-sm" @click="openModal('proyecto')">Mis Proyectos</button>
          </div>
          <div v-else class="row g-4">
            <div v-for="p in proyectosFiltradosBuscador" :key="p.id" class="col-12 col-md-6 col-xl-4">
  
              <div class="card border-0 shadow-sm h-100 hover-card project-card position-relative overflow-hidden"
                  :style="{ borderTop: '4px solid ' + getProjectTypeInfo(p.id_tipo_proyecto).color }">
                
                <div class="card-body d-flex flex-column pt-3">
                  
                  <div class="d-flex justify-content-between align-items-center mb-2">
                  
                    <div class="d-flex align-items-center gap-1">
                        
                        <span class="badge border fw-normal text-white shadow-sm d-flex align-items-center" 
                              :style="{ backgroundColor: getProjectTypeInfo(p.id_tipo_proyecto).color }"
                              style="font-size: 0.65rem; letter-spacing: 0.5px;">
                          {{ getProjectTypeInfo(p.id_tipo_proyecto).nombre }}
                        </span>

                        <span class="badge bg-light text-secondary border fw-normal text-uppercase" 
                              style="letter-spacing: 0.5px; font-size: 0.65rem;">
                          <i class="bi bi-hash"></i> {{ p.codigo }}
                        </span>
                        
                    </div>
                    
                    <span class="badge rounded-pill border px-3 py-1"
                          :style="{ 
                            backgroundColor: p.stageColor + '20', 
                            color: p.stageColor, 
                            borderColor: p.stageColor + '40' 
                          }">
                      {{ p.stageText }}
                    </span>

                  </div>

                  <h5 class="card-title fw-bold text-dark mb-1 text-truncate" :title="p.nombre_obra">
                    {{ p.nombre_obra }}
                  </h5>
                  <div class="mb-3 text-muted small d-flex align-items-center text-truncate">
                    <i class="bi bi-building me-1 opacity-50"></i> 
                    <span>{{ p.cliente }}</span>
                  </div>

                  <div class="row g-0 mb-3 small text-muted">
                    <div class="col-6 d-flex align-items-center">
                      <i class="bi bi-geo-alt-fill text-danger opacity-50 me-2"></i>
                      <span class="text-truncate">{{ p.ubicacion || 'Sin ubicaci√≥n' }}</span>
                    </div>
                    <div class="col-6 d-flex align-items-center justify-content-end">
                      <i class="bi bi-calendar-range text-primary opacity-50 me-2"></i>
                      <span style="font-variant-numeric: tabular-nums;">
                        {{ formatDate(p.fecha_inicio) }} - {{ formatDate(p.fecha_fin) }}
                      </span>
                    </div>
                  </div>

                  <div class="flex-grow-1" style="max-width: 100%;">
                    <div class="d-flex justify-content-between small mb-1">
                      <span class="fw-bold text-muted" style="font-size: 0.65rem; letter-spacing: 0.5px;">AVANCE</span>
                      <span class="fw-bold text-expert" style="font-size: 0.75rem;">{{ calculateProjectProgress(p.id) }}%</span>
                    </div>
                    <div class="progress shadow-sm" style="height: 6px; background-color: #f0f0f0;">
                      <div class="progress-bar bg-expert" 
                          role="progressbar" 
                          :style="{width: calculateProjectProgress(p.id) + '%'}">
                      </div>
                    </div>
                  </div>

                  <div class="mt-auto pt-3 border-top border-light d-flex align-items-center justify-content-between">
                    <span class="text-muted small fw-bold text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Equipo</span>
                    
                    <div class="d-flex align-items-center ps-2" style="height: 30px;">
                        <span v-if="getProjectTeam(p.id).length === 0" class="small text-muted fst-italic" style="font-size: 0.7rem;">
                          Sin asignar
                        </span>

                        <div v-else class="d-flex align-items-center">
                            <div v-for="(member, i) in getProjectTeam(p.id).slice(0, 4)" :key="member.id"
                                class="rounded-circle border border-2 border-white d-flex align-items-center justify-content-center text-white small shadow-sm"
                                :style="{
                                    width: '30px', 
                                    height: '30px', 
                                    marginLeft: i > 0 ? '-10px' : '0', 
                                    backgroundColor: i % 2 === 0 ? 'var(--color-base)' : '#6c757d',
                                    fontSize: '0.7rem',
                                    cursor: 'help'
                                }"
                                :title="member.nombre_completo + ' (' + member.rol + ')'"
                                data-bs-toggle="tooltip">
                                {{ member.nombre_completo.charAt(0).toUpperCase() }}{{ member.nombre_completo.split(' ')[1] ? member.nombre_completo.split(' ')[1].charAt(0).toUpperCase() : '' }}
                            </div>
                            <div v-if="getProjectTeam(p.id).length > 4"
                                class="rounded-circle border border-2 border-white d-flex align-items-center justify-content-center bg-light text-muted small fw-bold shadow-sm"
                                style="width: 30px; height: 30px; margin-left: -10px; font-size: 0.7rem;">
                                +{{ getProjectTeam(p.id).length - 4 }}
                            </div>
                        </div>
                    </div>
                  </div>

                </div> 

                <div class="card-footer bg-white border-top-0 pb-3 pt-0 d-flex justify-content-between align-items-center">
                  
                  <div class="d-flex gap-1">
                    <template v-if="currentUserProfile && currentUserProfile.rol_sistema === 'Admin'">
                        <button class="btn btn-sm btn-light text-muted border-0 hover-danger" 
                                @click.stop="deleteProject(p)" title="Eliminar">
                          <i class="bi bi-trash"></i>
                        </button>
                        <button class="btn btn-sm btn-light text-muted border-0 hover-warning" 
                                @click.stop="resetProject(p)" title="Resetear">
                          <i class="bi bi-arrow-repeat"></i>
                        </button>
                        <button class="btn btn-sm btn-light text-muted border-0 hover-primary" 
                                @click.stop="openModal('proyecto', p)" title="Editar">
                          <i class="bi bi-pencil"></i>
                        </button>
                    </template>
                  </div>

                  <button class="btn btn-sm btn-expert rounded-pill fw-bold shadow-sm transition-effect" 
                          :class="currentUserProfile && currentUserProfile.rol_sistema === 'Admin' ? 'px-4' : 'w-100 py-2'" 
                          @click="openProjectDetail(p)">
                    Gestionar <i class="bi bi-chevron-right ms-1" style="font-size: 0.7rem;"></i>
                  </button>

                </div>
              </div>
            </div>
            <div v-if="(proyectos && proyectos.length > 0) && (proyectosFiltradosBuscador && proyectosFiltradosBuscador.length === 0)" class="col-12 text-center py-5 text-muted">
              <i class="bi bi-search display-6 opacity-25"></i>
              <p class="mt-2">No encontramos coincidencias para "<strong>{{ searchQuery }}</strong>"</p>
              <button class="btn btn-sm btn-outline-secondary" @click="searchQuery = ''">Limpiar filtro</button>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'project-detail'" class="fade-in">
            <div class="bg-white p-3 rounded shadow-sm mb-4 sticky-top position-relative overflow-hidden fade-in"
                style="top: 10px; z-index: 1010; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;"
                :style="{ borderTop: '4px solid ' + getProjectTypeInfo(activeProject.id_tipo_proyecto).color }">
            
            <div class="d-flex justify-content-between align-items-start mb-2">
              
              <div class="d-flex align-items-center gap-1">
                  <span class="badge border fw-normal text-white shadow-sm d-flex align-items-center" 
                        :style="{ backgroundColor: getProjectTypeInfo(activeProject.id_tipo_proyecto).color }"
                        style="font-size: 0.65rem; letter-spacing: 0.5px;">
                     {{ getProjectTypeInfo(activeProject.id_tipo_proyecto).nombre }}
                  </span>
                  <span class="badge bg-light text-secondary border fw-normal text-uppercase" style="letter-spacing: 0.5px; font-size: 0.65rem;">
                    <i class="bi bi-hash"></i> {{ activeProject.codigo }}
                  </span>
              </div>

              <div class="d-flex align-items-center gap-2">
                  <span class="badge rounded-pill border px-3 py-1"
                        :style="{ 
                          backgroundColor: activeProject.stageColor + '20', 
                          color: activeProject.stageColor, 
                          borderColor: activeProject.stageColor + '40' 
                        }">
                    {{ activeProject.stageText }}
                  </span>
                  
                  <button class="btn btn-sm btn-light border rounded-circle d-flex align-items-center justify-content-center" 
                          style="width: 28px; height: 28px;"
                          @click="navigate('projects')" 
                          title="Cerrar y volver">
                      <i class="bi bi-x-lg text-muted"></i>
                  </button>
              </div>
            </div>

            <div class="d-flex flex-column mb-3">
                <h5 class="fw-bold text-dark mb-1 text-truncate">{{ activeProject.nombre_obra }}</h5>
                <div class="text-muted small d-flex align-items-center">
                    <i class="bi bi-building me-1 opacity-50"></i> 
                    <span>{{ activeProject.cliente }}</span>
                </div>
            </div>

            <div class="row g-0 mb-3 small text-muted bg-light p-2 rounded mx-0">
                <div class="col-6 d-flex align-items-center">
                  <i class="bi bi-geo-alt-fill text-danger opacity-50 me-2"></i>
                  <span class="text-truncate">{{ activeProject.ubicacion || 'Sin ubicaci√≥n' }}</span>
                </div>
                <div class="col-6 d-flex align-items-center justify-content-end">
                  <i class="bi bi-calendar-range text-primary opacity-50 me-2"></i>
                  <span style="font-variant-numeric: tabular-nums;">
                     {{ formatDate(activeProject.fecha_inicio) }} - {{ formatDate(activeProject.fecha_fin) }}
                  </span>
                </div>
            </div>

            <div class="pt-2 border-top d-flex align-items-center justify-content-between flex-wrap gap-3">
               
               <div class="d-flex align-items-center">
                   <span class="text-muted small fw-bold text-uppercase me-2" style="font-size: 0.65rem; letter-spacing: 1px;">Equipo:</span>
                   
                   <span v-if="getProjectTeam(activeProject.id).length === 0" class="badge bg-light text-muted border fw-normal">
                       Sin asignar
                   </span>

                   <div v-else class="d-flex">
                        <div v-for="(member, i) in getProjectTeam(activeProject.id).slice(0, 5)" :key="member.id"
                             class="rounded-circle border border-2 border-white d-flex align-items-center justify-content-center text-white small shadow-sm"
                             :style="{
                                 width: '32px', 
                                 height: '32px', 
                                 marginLeft: i > 0 ? '-10px' : '0', 
                                 backgroundColor: i % 2 === 0 ? 'var(--color-base)' : '#6c757d',
                                 fontSize: '0.75rem',
                                 cursor: 'help'
                             }"
                             :title="member.nombre_completo"
                             data-bs-toggle="tooltip">
                             {{ member.nombre_completo.charAt(0).toUpperCase() }}{{ member.nombre_completo.split(' ')[1] ? member.nombre_completo.split(' ')[1].charAt(0).toUpperCase() : '' }}
                        </div>
                   </div>
               </div>

               <div class="flex-grow-1" style="min-width: 150px; max-width: 70%;">
                  <div class="d-flex justify-content-between small mb-1">
                    <span class="fw-bold text-expert" style="font-size: 0.7rem;">AVANCE GLOBAL</span>
                    <span class="fw-bold">{{ globalProgress }}%</span>
                  </div>
                  <div class="progress shadow-sm" style="height: 8px; background-color: #e9ecef;">
                    <div class="progress-bar bg-expert" 
                         role="progressbar" 
                         :style="{width: globalProgress + '%'}">
                    </div>
                  </div>
               </div>
            </div>
          </div>

          <div class="accordion" id="accordionObras">
            <div v-for="etapa in projectStructure" :key="etapa.id"
              class="accordion-item border-0 shadow-sm mb-3 rounded overflow-hidden">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-white py-3" type="button" data-bs-toggle="collapse"
                  :data-bs-target="'#collapse'+etapa.id">
                  <div class="d-flex align-items-center w-100 pe-3">
                    <div
                      class="me-3 d-flex align-items-center justify-content-center text-white fw-bold rounded-circle shadow-sm"
                      :style="{width:'32px', height:'32px', backgroundColor: etapa.color_hex, fontSize: '0.8rem'}">
                      {{ etapa.orden }}
                    </div>
                    <div class="flex-grow-1">
                      <div class="fw-bold text-dark lh-1">{{ etapa.nombre_etapa }}</div>
                      <div class="d-flex align-items-center mt-1">
                        <div class="progress flex-grow-1 me-2" style="height: 4px; background-color: #e9ecef;">
                          <div class="progress-bar"
                            :style="{width: etapa.progress + '%', backgroundColor: etapa.color_hex}"></div>
                        </div>
                        <small class="text-muted" style="font-size: 0.7rem;">{{ etapa.progress }}%</small>
                      </div>
                    </div>
                  </div>
                </button>
              </h2>
              <div :id="'collapse'+etapa.id" class="accordion-collapse collapse" data-bs-parent="#accordionObras">
                <div class="accordion-body bg-light p-0">
                  
                  <div v-for="(itemTarea, indice) in etapa.tasks" :key="itemTarea.id + '_' + indice" class="border-bottom p-3 bg-white">
                    <div v-if="itemTarea">
                      
                      <div class="d-flex align-items-start mb-2">
                        
                        <div class="me-3 cursor-pointer" @click="toggleTaskState(itemTarea)" style="min-width: 24px;">
                          <i v-if="itemTarea.estado === 'Completado'" class="bi bi-check-circle-fill text-success fs-4"></i>
                          <i v-else class="bi bi-circle text-muted fs-4"></i>
                        </div>
                        
                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between align-items-center">
                            
                            <label class="mb-0 fw-bold text-dark cursor-pointer" 
                                  :class="{'text-decoration-line-through text-muted': itemTarea.estado === 'Completado'}" 
                                  @click="toggleTaskState(itemTarea)">
                              {{ itemTarea.nombre_tarea }}
                            </label>
                            
                            <div class="d-flex gap-1 align-items-center">
                              <button v-if="itemTarea.checklist_id" 
                                      class="btn btn-sm py-0 px-2 rounded-pill transition-effect d-flex align-items-center"
                                      :class="hasChecklistData(itemTarea) ? 'btn-primary text-white shadow-sm' : 'btn-outline-primary'"
                                      @click.stop="openFillChecklist(itemTarea)">
                                <i class="bi me-1" :class="hasChecklistData(itemTarea) ? 'bi-clipboard-check-fill' : 'bi-clipboard'"></i>
                                <span class="d-none d-sm-inline">Protocolo</span>
                              </button>

                              <div v-if="itemTarea.requiere_evidencia">  
                                <div v-if="hasValidEvidence(itemTarea)" class="btn-group shadow-sm" role="group">
                                  <a :href="itemTarea.datos_evidencia" target="_blank" 
                                    class="btn btn-sm btn-success text-white py-0 px-2 rounded-start-pill d-flex align-items-center text-decoration-none" 
                                    title="Ver Documento">
                                    <i class="bi bi-file-earmark-check-fill me-1"></i> 
                                    <span class="d-none d-sm-inline">Ver</span>
                                  </a>
                                  <button class="btn btn-sm btn-success border-start border-white border-opacity-25 py-0 px-2 rounded-end-pill"
                                          @click.stop="triggerFileUpload(itemTarea)" 
                                          title="Reemplazar archivo">
                                    <i class="bi bi-arrow-repeat"></i>
                                  </button>
                                </div>

                                <button v-else 
                                        class="btn btn-sm btn-outline-warning text-dark py-0 px-2 rounded-pill d-flex align-items-center"
                                        @click.stop="triggerFileUpload(itemTarea)"
                                        title="Adjuntar Evidencia Obligatoria">
                                  <i class="bi bi-paperclip me-1"></i> 
                                  <span class="d-none d-sm-inline">Adjuntar</span>
                                </button>

                                <input type="file" 
                                      :id="'fileInput_' + itemTarea.id" 
                                      class="d-none" 
                                      accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png"
                                      @change="(e) => handleFileUpload(e, itemTarea)"
                                      @click.stop> 
                              </div>

                            </div>

                          </div>
                        </div>
                      </div>

                      <div class="ms-4 ps-2">
                        <div class="input-group input-group-sm">
                          <span class="input-group-text bg-light border-0 text-muted"><i class="bi bi-chat-left-text"></i></span>
                          
                          <textarea v-if="itemTarea.tipo_entrada === 'textarea'" class="form-control bg-light border-0 rounded-end text-muted" rows="2" 
                            v-model="itemTarea.comentarios" @change="updateTask(itemTarea)">
                            </textarea>
                          <input v-else type="text" class="form-control bg-light border-0 rounded-end text-muted" v-model="itemTarea.comentarios" @change="updateTask(itemTarea)">
                        </div>
                      </div>
                    </div>
                  </div>
                  </div>
              </div>
            </div>
          </div>
          <div style="height: 80px;"></div>
        </div>

        <!-- ========== VISTA DE REPORTES ========== -->
        <div v-if="currentView === 'reports'" class="fade-in">
          <!-- Header con t√≠tulo y bot√≥n de exportar -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h4 class="fw-bold mb-0 text-dark"><i class="bi bi-file-earmark-bar-graph me-2"></i>Reportes Ejecutivos</h4>
              <small class="text-muted">An√°lisis consolidado de proyectos y avances</small>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-expert btn-sm" @click="resetReportFilters">
                <i class="bi bi-funnel"></i> Limpiar Filtros
              </button>
              <button class="btn btn-expert btn-sm" @click="loadReportData">
                <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
              </button>
            </div>
          </div>

          <!-- Panel de Filtros -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-expert text-white">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>Filtros Avanzados</h6>
                <button class="btn btn-sm btn-light" @click="toggleFilters">
                  <i class="bi" :class="showFilters ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                </button>
              </div>
            </div>
            
            <div class="card-body" v-show="showFilters">
              <div class="row g-3">
                
                <!-- Filtro por Tipo de Proyecto -->
                <div class="col-md-2">
                  <label class="form-label small fw-bold text-muted">Tipo de Proyecto</label>
                  <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                    <div v-for="tipo in reportTipos" :key="tipo.id" class="form-check small">
                      <input class="form-check-input" type="checkbox" :value="tipo.id" 
                            v-model="reportFilters.tipos" :id="'tipo_'+tipo.id">
                      <label class="form-check-label" :for="'tipo_'+tipo.id">
                        <span class="badge rounded-pill me-1" :style="{backgroundColor: tipo.color_representativo}">&nbsp;</span>
                        {{ tipo.nombre_tipo }}
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Filtro por Profesionales -->
                <div class="col-md-2">
                  <label class="form-label small fw-bold text-muted">Profesionales</label>
                  <div class="border rounded p-2 bg-light" style="max-height: 150px; overflow-y: auto;">
                    <div v-for="prof in reportProfesionales" :key="prof.id" class="form-check small">
                      <input class="form-check-input" type="checkbox" :value="prof.id" 
                            v-model="reportFilters.profesionales" :id="'prof_'+prof.id">
                      <label class="form-check-label" :for="'prof_'+prof.id">
                        {{ prof.nombre_completo }}
                      </label>
                    </div>
                  </div>
                </div>

                <!-- Filtro por Fechas -->
                <div class="col-md-3">
                  <label class="form-label small fw-bold text-muted">Fecha de Inicio</label>
                  <div class="row g-1">
                    <div class="col-6">
                      <input type="date" v-model="reportFilters.fechaInicioDesde" class="form-control form-control-sm" placeholder="Desde">
                    </div>
                    <div class="col-6">
                      <input type="date" v-model="reportFilters.fechaInicioHasta" class="form-control form-control-sm" placeholder="Hasta">
                    </div>
                  </div>
                  <label class="form-label small fw-bold text-muted mt-2">Fecha de Fin</label>
                  <div class="row g-1">
                    <div class="col-6">
                      <input type="date" v-model="reportFilters.fechaFinDesde" class="form-control form-control-sm" placeholder="Desde">
                    </div>
                    <div class="col-6">
                      <input type="date" v-model="reportFilters.fechaFinHasta" class="form-control form-control-sm" placeholder="Hasta">
                    </div>
                  </div>
                </div>

                <!-- Filtro por % de Avance -->
                <div class="col-md-3">
                  <label class="form-label small fw-bold text-muted">% de Avance</label>
                  <div class="input-group input-group-sm mb-1">
                    <select v-model="reportFilters.avanceOperador" class="form-select">
                      <option value="=">=</option>
                      <option value=">">></option>
                      <option value="<"><</option>
                    </select>
                    <input type="number" v-model.number="reportFilters.avanceValor" 
                          class="form-control" min="0" max="100" step="5" placeholder="0-100">
                    <span class="input-group-text">%</span>
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Encabezado de Resultados con Ordenamiento -->
          <div class="card border-0 shadow-sm mb-3">
            <div class="card-body p-3">
              <div class="row align-items-center">

                <!-- T√≠tulo de la secci√≥n -->
                <div class="col-md-3">
                  <h5 class="mb-0 fw-bold text-dark">
                    <i class="bi bi-list-ul me-2 text-expert"></i>
                    Proyectos Filtrados
                  </h5>
                  <small class="text-muted">
                    {{ reportProyectosFiltrados.length }}
                    {{ reportProyectosFiltrados.length === 1 ? 'proyecto encontrado' : 'proyectos encontrados' }}
                  </small>
                </div>

                <!-- Opciones de Ordenamiento -->
                <div class="col-md-9">
                  <div class="d-flex align-items-center justify-content-end gap-2 flex-wrap">

                    <!-- Label -->
                    <div class="text-muted small fw-bold text-uppercase d-none d-md-block"
                      style="white-space: nowrap; letter-spacing: 0.5px;">
                      <i class="bi bi-sort-down me-1"></i>Ordenar:
                    </div>
                    <!-- Botones de campo -->
                    <div class="btn-group shadow-sm" role="group">
                      <input type="radio" class="btn-check" name="sortField" id="sortNombre" @click="setSortField('nombre')"
                        :checked="reportSort.field === 'nombre'">
                      <label class="btn btn-outline-expert btn-sm" for="sortNombre">
                        <i class="bi bi-tag d-md-none"></i>
                        <span class="d-none d-md-inline"><i class="bi bi-tag me-1"></i>Nombre</span>
                      </label>

                      <input type="radio" class="btn-check" name="sortField" id="sortCodigo" @click="setSortField('codigo')"
                        :checked="reportSort.field === 'codigo'">
                      <label class="btn btn-outline-expert btn-sm" for="sortCodigo">
                        <i class="bi bi-hash d-md-none"></i>
                        <span class="d-none d-md-inline"><i class="bi bi-hash me-1"></i>C√≥digo</span>
                      </label>

                      <input type="radio" class="btn-check" name="sortField" id="sortProgreso"
                        @click="setSortField('progreso_global')" :checked="reportSort.field === 'progreso_global'">
                      <label class="btn btn-outline-expert btn-sm" for="sortProgreso">
                        <i class="bi bi-bar-chart d-md-none"></i>
                        <span class="d-none d-md-inline"><i class="bi bi-bar-chart me-1"></i>Avance</span>
                      </label>

                      <input type="radio" class="btn-check" name="sortField" id="sortFechaInicio"
                        @click="setSortField('fecha_inicio')" :checked="reportSort.field === 'fecha_inicio'">
                      <label class="btn btn-outline-expert btn-sm" for="sortFechaInicio">
                        <i class="bi bi-calendar-event d-md-none"></i>
                        <span class="d-none d-md-inline"><i class="bi bi-calendar-event me-1"></i>F. Inicio</span>
                      </label>

                      <input type="radio" class="btn-check" name="sortField" id="sortFechaFin" @click="setSortField('fecha_fin')"
                        :checked="reportSort.field === 'fecha_fin'">
                      <label class="btn btn-outline-expert btn-sm" for="sortFechaFin">
                        <i class="bi bi-calendar-check d-md-none"></i>
                        <span class="d-none d-md-inline"><i class="bi bi-calendar-check me-1"></i>F. Fin</span>
                      </label>
                    </div>

                    <!-- Bot√≥n de orden ascendente/descendente -->
                    <button class="btn btn-outline-expert btn-sm shadow-sm d-flex align-items-center" @click="toggleSortOrder"
                      :title="reportSort.order === 'asc' ? 'Orden ascendente' : 'Orden descendente'">
                      <i class="bi me-1"
                        :class="reportSort.order === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-down-alt'"></i>
                      <span class="d-none d-lg-inline">
                        {{ reportSort.order === 'asc' ? 'A ‚Üí Z' : 'Z ‚Üí A' }}
                      </span>
                    </button>

                    <!-- Separador vertical -->
                    <div class="vr d-none d-md-block" style="height: 30px; opacity: 0.3;"></div>

                    <div class="bg-light p-1 rounded border d-flex me-3">
                      <button class="btn btn-sm border-0 rounded transition-effect"
                        :class="reportViewMode === 'list' ? 'bg-white shadow-sm text-expert fw-bold' : 'text-muted'"
                        @click="reportViewMode = 'list'">
                        <i class="bi bi-list-task me-1"></i> Lista
                      </button>
                      <button class="btn btn-sm border-0 rounded transition-effect"
                        :class="reportViewMode === 'gantt' ? 'bg-white shadow-sm text-expert fw-bold' : 'text-muted'"
                        @click="reportViewMode = 'gantt'">
                        <i class="bi bi-kanban me-1"></i> Gantt
                      </button>
                    </div>

                    <!-- Bot√≥n de Imprimir/Exportar PDF -->
                    <button class="btn btn-expert btn-sm shadow-sm d-flex align-items-center gap-1" @click="exportReportToPDF"
                      :disabled="reportProyectosFiltrados.length === 0 || loading">
                      <i class="bi bi-file-earmark-pdf fs-6"></i>
                      <span class="d-none d-sm-inline">Exportar PDF</span>
                    </button>



                    <div v-if="reportViewMode === 'list'" class="d-flex gap-2">
                      <div class="btn-group shadow-sm" role="group">
                        <input type="radio" class="btn-check" name="sortField" id="sortNombre" @click="setSortField('nombre')"
                          :checked="reportSort.field === 'nombre'">
                        <label class="btn btn-outline-expert btn-sm" for="sortNombre"><i class="bi bi-tag"></i></label>

                        <input type="radio" class="btn-check" name="sortField" id="sortProgreso"
                          @click="setSortField('progreso_global')" :checked="reportSort.field === 'progreso_global'">
                        <label class="btn btn-outline-expert btn-sm" for="sortProgreso"><i class="bi bi-bar-chart"></i></label>

                        <input type="radio" class="btn-check" name="sortField" id="sortFechaInicio"
                          @click="setSortField('fecha_inicio')" :checked="reportSort.field === 'fecha_inicio'">
                        <label class="btn btn-outline-expert btn-sm" for="sortFechaInicio"><i class="bi bi-calendar"></i></label>
                      </div>
                      <button class="btn btn-outline-expert btn-sm shadow-sm" @click="toggleSortOrder">
                        <i class="bi" :class="reportSort.order === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-down-alt'"></i>
                      </button>
                    </div>

                    <div v-if="reportViewMode === 'gantt'" class="d-flex gap-1 align-items-center">
                      <span class="small text-muted me-2 fw-bold">Zoom:</span>
                      <select v-model="ganttScale" class="form-select form-select-sm" style="width: 120px;">
                        <option value="quarter">Trimestral</option>
                        <option value="semester">Semestral</option>
                        <option value="year">Anual</option>
                      </select>
                    </div>

                    <div class="vr d-none d-md-block mx-2" style="height: 20px;"></div>

                    <button class="btn btn-expert btn-sm shadow-sm" @click="exportReportToPDF"
                      :disabled="reportProyectosFiltrados.length === 0 || loading">
                      <i class="bi bi-file-earmark-pdf"></i>
                    </button>

                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-if="reportViewMode === 'list'">
          <!-- Lista de Proyectos en Acorde√≥n -->
          <div v-if="reportProyectosFiltrados.length === 0" class="alert alert-warning text-center">
            <i class="bi bi-funnel display-4 opacity-25 d-block mb-2"></i>
            <strong>No se encontraron proyectos</strong> con los filtros aplicados.
          </div>

          <div v-else class="accordion" id="reportAccordion">
            <div v-for="(proyecto, index) in reportProyectosFiltrados" :key="proyecto.id"
              class="accordion-item border-0 shadow-sm mb-3 rounded overflow-hidden">

              <!-- Nivel 1: Cabecera del Proyecto -->
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                  :data-bs-target="'#proyecto_'+index" :aria-controls="'proyecto_'+index">
                  <div class="d-flex align-items-center w-100 pe-3">

                    <!-- Indicador de tipo -->
                    <div class="me-3">
                      <span class="badge" :style="{backgroundColor: proyecto.tipo_color}">
                        {{ proyecto.tipo_nombre }}
                      </span>
                    </div>

                    <!-- Info principal -->
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        <strong class="me-2">{{ proyecto.nombre }}</strong>
                        <span class="badge bg-light text-dark border small">{{ proyecto.codigo }}</span>
                      </div>
                      <div class="small text-muted">
                        <i class="bi bi-building me-1"></i>{{ proyecto.cliente }}
                        <i class="bi bi-geo-alt ms-3 me-1"></i>{{ proyecto.ubicacion }}
                        <i class="bi bi-calendar-range ms-3 me-1"></i>{{ formatDate(proyecto.fecha_inicio) }} - {{
                        formatDate(proyecto.fecha_fin) }}
                      </div>
                    </div>

                    <!-- Progreso -->
                    <div style="min-width: 150px;" class="me-3">
                      <div class="d-flex justify-content-between small mb-1">
                        <span class="text-muted">Avance</span>
                        <strong class="text-expert">{{ proyecto.progreso_global }}%</strong>
                      </div>
                      <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-expert" :style="{width: proyecto.progreso_global + '%'}"></div>
                      </div>
                    </div>

                    <!-- Etapa actual -->
                    <div class="text-end" style="min-width: 120px;">
                      <span class="badge rounded-pill px-3"
                        :style="{backgroundColor: proyecto.etapa_color + '20', color: proyecto.etapa_color, borderColor: proyecto.etapa_color}">
                        {{ proyecto.etapa_actual }}
                      </span>
                    </div>

                  </div>
                </button>
              </h2>

              <!-- Nivel 1: Contenido del Proyecto -->
              <div :id="'proyecto_'+index" class="accordion-collapse collapse" data-bs-parent="#reportAccordion">
                <div class="accordion-body p-0 bg-light">

                  <!-- Info adicional del proyecto -->
                  <div class="p-3 bg-white border-bottom">
                    <div class="row g-3">
                      <div class="col-md-4">
                        <strong class="small text-muted d-block mb-1">Equipo Asignado</strong>
                        <div v-if="proyecto.equipo.length === 0" class="small text-muted fst-italic">Sin asignar</div>
                        <div v-else class="d-flex flex-wrap gap-1">
                          <span v-for="miembro in proyecto.equipo" :key="miembro.id"
                            class="badge bg-light text-dark border small">
                            {{ miembro.nombre }} ({{ miembro.rol }})
                          </span>
                        </div>
                      </div>
                      <div class="col-md-4">
                        <strong class="small text-muted d-block mb-1">Carpeta Drive</strong>
                        <a v-if="proyecto.drive_url" :href="proyecto.drive_url" target="_blank"
                          class="btn btn-sm btn-outline-primary">
                          <i class="bi bi-folder2-open me-1"></i>Abrir en Drive
                        </a>
                        <div v-else class="small text-muted fst-italic">No configurada</div>
                      </div>
                      <div class="col-md-4">
                        <strong class="small text-muted d-block mb-1">Totales</strong>
                        <div class="small">
                          <i class="bi bi-list-task me-1"></i>{{ getProyectoTotalTareas(proyecto) }} tareas
                          <span class="ms-2">
                            <i class="bi bi-check-circle text-success me-1"></i>{{ getProyectoTareasCompletadas(proyecto) }}
                            completadas
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Nivel 2: Acorde√≥n de Etapas -->
                  <div class="accordion" :id="'etapas_'+index">
                    <div v-for="(etapa, etapaIndex) in proyecto.etapas" :key="etapa.id"
                      class="accordion-item border-0 border-bottom">

                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse"
                          :data-bs-target="'#etapa_'+index+'_'+etapaIndex">
                          <div class="d-flex align-items-center w-100 pe-3">

                            <div class="me-3">
                              <div
                                class="rounded-circle d-flex align-items-center justify-content-center text-white fw-bold shadow-sm"
                                :style="{width:'32px', height:'32px', backgroundColor: etapa.color, fontSize: '0.8rem'}">
                                {{ etapa.orden }}
                              </div>
                            </div>

                            <div class="flex-grow-1">
                              <strong>{{ etapa.nombre }}</strong>
                              <div class="small text-muted">
                                {{ etapa.tareas_completadas }} / {{ etapa.total_tareas }} tareas completadas
                              </div>
                            </div>

                            <div style="min-width: 120px;">
                              <div class="d-flex justify-content-between small mb-1">
                                <span class="text-muted">Progreso</span>
                                <strong>{{ etapa.progreso }}%</strong>
                              </div>
                              <div class="progress" style="height: 4px;">
                                <div class="progress-bar" :style="{width: etapa.progreso + '%', backgroundColor: etapa.color}">
                                </div>
                              </div>
                            </div>

                          </div>
                        </button>
                      </h2>

                      <!-- Nivel 3: Lista de Tareas -->
                      <div :id="'etapa_'+index+'_'+etapaIndex" class="accordion-collapse collapse">
                        <div class="accordion-body p-0">
                          <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                              <tr>
                                <th style="width: 40px;" class="text-center">Estado</th>
                                <th>Tarea</th>
                                <th style="width: 150px;">Evidencia</th>
                                <th style="width: 200px;">Comentarios</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr v-for="tarea in etapa.tareas" :key="tarea.id">
                                <td class="text-center">
                                  <i v-if="tarea.estado === 'Completado'" class="bi bi-check-circle-fill text-success fs-5"></i>
                                  <i v-else class="bi bi-circle text-muted fs-5"></i>
                                </td>
                                <td>
                                  <div :class="{'text-decoration-line-through text-muted': tarea.estado === 'Completado'}">
                                    {{ tarea.nombre }}
                                  </div>
                                  <div v-if="tarea.requiere_evidencia" class="small text-warning">
                                    <i class="bi bi-paperclip me-1"></i>Requiere evidencia
                                  </div>
                                </td>
                                <td>
                                  <a v-if="tarea.tiene_evidencia" :href="tarea.evidencia_url" target="_blank"
                                    class="btn btn-sm btn-success">
                                    <i class="bi bi-file-earmark-check me-1"></i>Ver archivo
                                  </a>
                                  <span v-else class="text-muted small fst-italic">Sin archivo</span>
                                </td>
                                <td>
                                  <div class="small text-muted text-truncate" style="max-width: 200px;"
                                    :title="tarea.comentarios">
                                    {{ tarea.comentarios || '‚Äî' }}
                                  </div>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>

                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>
        </div>

        <div v-else class="fade-in">
          <div v-if="reportProyectosFiltrados.length === 0" class="alert alert-warning text-center">
            No hay datos para mostrar en el Gantt.
          </div>

          <div v-else class="gantt-container shadow-sm">

            <div class="gantt-header" style="left: 200px; /* Ancho del sidebar */">
              <div class="gantt-sidebar-item bg-light text-muted small fw-bold text-uppercase">
                
              </div>
              <div v-for="mes in ganttTimeline" :key="mes.key" class="gantt-header-cell"
                :style="{ width: ganttColumnWidth + 'px' }">
                {{ mes.label }} <br> <span style="font-size: 0.6rem; color: #999;">{{ mes.year }}</span>
              </div>
            </div>

            <div class="gantt-body">

              <div class="gantt-grid-lines" style="left: 200px; /* Ancho del sidebar */">
                <div v-for="mes in ganttTimeline" :key="'line_'+mes.key" class="gantt-grid-line"
                  :style="{ width: ganttColumnWidth + 'px' }">
                </div>
              </div>

              <div v-for="p in reportProyectosFiltrados" :key="p.id" class="gantt-row">

                <div class="gantt-sidebar-item">
                  <div class="text-truncate w-100" :title="p.nombre">
                    <div class="fw-bold text-dark small">{{ p.nombre }}</div>
                    <div class="text-muted" style="font-size: 0.65rem;">{{ p.etapa_actual }}</div>
                  </div>
                </div>

                <div class="gantt-timeline-wrapper">
                  <div class="gantt-bar" v-if="p.fecha_inicio && p.fecha_fin" :style="getGanttBarStyle(p)"
                    :title="`${p.nombre}: ${formatDate(p.fecha_inicio)} - ${formatDate(p.fecha_fin)} (${p.progreso_global}%)`">

                    <div class="gantt-bar-progress" :style="{ width: p.progreso_global + '%' }"></div>

                    <span class="gantt-bar-label">{{ p.progreso_global }}%</span>
                  </div>

                  <div v-else class="ps-3 text-muted small fst-italic d-flex align-items-center h-100">
                    <i class="bi bi-exclamation-circle me-1"></i> Sin fechas definidas
                  </div>
                </div>
              </div>

            </div>
          </div>
          <div class="mt-2 small text-muted text-end">
            <i class="bi bi-info-circle me-1"></i> Mostrando rango de fechas basado en los proyectos filtrados.
          </div>
        </div>


        </div> <!-- ========== CIERRE VISTA DE REPORTES ========== -->

      </main>

      <div class="modal fade" id="modal-etapa" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-expert text-white">
              <h5 class="modal-title fs-6">Nueva Etapa</h5><button class="btn-close btn-close-white"
                data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
              <div class="mb-3">
                <label class="form-label small fw-bold">Nombre</label>
                <input type="text" v-model="form.nombre_etapa" class="form-control" placeholder="Ej: Obra Gris">
              </div>
              
              <div class="mb-3">
                <label class="form-label small fw-bold">Descripci√≥n</label>
                <textarea v-model="form.descripcion" class="form-control" rows="2" placeholder="Detalle opcional de esta etapa..."></textarea>
              </div>
              
              <div class="row">
                <div class="col-6">
                    <label class="form-label small fw-bold">Orden</label>
                    <input type="number" v-model="form.orden" class="form-control">
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold">Color</label>
                    <input type="color" v-model="form.color_hex" class="form-control w-100 h-75">
                </div>
              </div>
            </div>
            <div class="modal-footer border-0 bg-white"><button class="btn btn-expert w-100 rounded-pill"
                @click="saveGeneric('CONF_ETAPAS')">Guardar</button></div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modal-profesional" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-expert text-white">
              <h5 class="modal-title fs-6">
                <i class="bi bi-person-badge me-2"></i>
                <span v-if="form.id">Editar Profesional</span>
                <span v-else>Nuevo Miembro del Equipo</span>
              </h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
              <div class="row g-2 mb-3">
                <div class="col-12"><label class="form-label small fw-bold text-muted">Nombre Completo *</label><input
                    type="text" v-model="form.nombre_completo" class="form-control" placeholder="Ej: Juan P√©rez">
                </div>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-6"><label class="form-label small fw-bold text-muted">Rol en Obra *</label><select
                    v-model="form.rol" class="form-select">
                    <option value="" disabled>Seleccione...</option>
                    <option value="Jefe de Proyectos">Jefe de Proyectos</option>
                    <option value="Proyectista Senior">Proyectista Senior</option>
                    <option value="Proyectista Junior">Proyectista Junior</option>
                    <option value="Asistente de Proyectos">Asistente de Proyectos</option>
                    <option value="Director de Obras">Director de Obra</option>
                    <option value="Residente">Residente</option>
                    <option value="Arquitecto">Arquitecto</option>
                    <option value="Ingeniero">Ingeniero</option>
                    <option value="Capataz">Capataz</option>
                    <option value="Administrativo">Administrativo</option>
                    <option value="Contratista">Contratista</option>
                  </select></div>
                <div class="col-6"><label class="form-label small fw-bold text-muted">Especialidad</label><input
                    type="text" v-model="form.especialidad" class="form-control" placeholder="Ej: Estructuras"></div>
              </div>
              <div class="card border-0 shadow-sm mb-3">
                <div class="card-body p-3">
                  <h6 class="card-subtitle mb-2 text-muted small fw-bold"><i class="bi bi-person-lines-fill me-1"></i>
                    Contacto</h6>
                  <div class="row g-2">
                    <div class="col-6"><label class="small text-muted">Email</label><input type="email"
                        v-model="form.email" class="form-control form-control-sm" placeholder="...@gmail.com"></div>
                    <div class="col-6"><label class="small text-muted">Tel√©fono / WhatsApp</label><input type="text"
                        v-model="form.telefono" class="form-control form-control-sm" placeholder="595 9..."></div>
                  </div>
                </div>
              </div>
              <div class="row g-2 align-items-end">
                <div class="col-6"><label class="form-label small fw-bold text-muted">Honorario por Hora</label>
                  <div class="input-group"><span class="input-group-text bg-white border-end-0">Gs.</span><input
                      type="number" v-model="form.costo_hora" class="form-control border-start-0" placeholder="0.00">
                  </div>
                </div>
                <div class="col-6">
                  <label for="perfilSistema" class="form-label">Perfil de Sistema</label>
                  <select id="perfilSistema" class="form-select" v-model="form.perfil_sistema" required>
                    <option value="" disabled>Seleccione un rol...</option>
                    <option value="Operador">Operador (Acceso Est√°ndar)</option>
                    <option value="Admin">Admin (Control Total)</option>
                  </select>
                </div>
                <div class="col-6">
                  <div class="form-check form-switch mb-2"><input class="form-check-input" type="checkbox"
                      id="estadoSwitch" v-model="form.estado" true-value="Activo" false-value="Inactivo"><label
                      class="form-check-label small" for="estadoSwitch">Estado: <strong>{{ form.estado || 'Activo'
                      }}</strong></label></div>
                </div>
              </div>
            </div>
            <div class="modal-footer border-0 bg-white"><button class="btn btn-expert w-100 rounded-pill shadow-sm"
                @click="saveGeneric('CONF_PROFESIONALES')"><i class="bi bi-save me-2"></i> Guardar Ficha</button></div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modal-checklist" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-expert text-white">
              <h5 class="modal-title fs-6"><i class="bi bi-list-task me-2"></i>Configurar Protocolo</h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light" v-if="currentChecklistTask">
              <div class="bg-white p-3 rounded shadow-sm mb-3">
                <label class="form-label small fw-bold text-muted">T√≠tulo del Protocolo</label>
                <input type="text" v-model="form.nombre_checklist" class="form-control"
                  placeholder="Ej: Inspecci√≥n de Cimentaci√≥n">
              </div>
              <div class="d-flex justify-content-between align-items-center mb-2 px-1">
                <small class="text-muted fw-bold text-uppercase" style="font-size: 0.7rem;">√çtems de Verificaci√≥n
                  (Arrastra para ordenar)</small>
                <button class="btn btn-sm btn-outline-expert rounded-pill" @click="addChecklistItem">
                  <i class="bi bi-plus-lg"></i> Agregar √çtem
                </button>
              </div>
              <div id="sortable-items" class="d-flex flex-column gap-2 pb-3">
                <div v-for="(item, idx) in form.items" :key="idx" class="card border-0 shadow-sm item-drag">
                  <div class="card-body p-2 d-flex align-items-center bg-white rounded">
                    <div class="me-3 text-muted cursor-move handle px-2" style="cursor: grab;">
                      <i class="bi bi-grip-vertical"></i>
                    </div>
                    <div class="flex-grow-1 row g-2 align-items-center">
                      <div class="col-md-7">
                        <input type="text" v-model="item.label" class="form-control form-control-sm border-0 bg-light"
                          placeholder="Escribe la pregunta o verificaci√≥n...">
                      </div>
                      <div class="col-md-4">
                        <select v-model="item.type" class="form-select form-select-sm border-0 bg-light text-muted">
                          <option value="checkvalue">‚òë Checkbox Simple</option>
                          <option value="radiobutton">‚óâ Opciones (Si/No)</option>
                          <option value="text">‚úé Texto Libre</option>
                        </select>
                      </div>
                    </div>
                    <button class="btn btn-sm text-danger ms-2" @click="form.items.splice(idx, 1)" title="Quitar √≠tem">
                      <i class="bi bi-x-circle-fill"></i>
                    </button>
                  </div>
                </div>
                <div v-if="!form.items || (Array.isArray(form.items) && form.items.length === 0)"
                  class="text-center py-4 border dashed rounded text-muted">
                  <i class="bi bi-arrow-up-circle fs-4"></i>
                  <p class="small mb-0">Agrega √≠tems para construir el protocolo.</p>
                </div>
              </div>
            </div>
            <div class="modal-footer border-0 bg-white">
              <button class="btn btn-expert w-100 rounded-pill shadow-sm" @click="saveChecklist">
                <i class="bi bi-save me-2"></i> Guardar Protocolo
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modal-tipo" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-expert text-white">
              <h5 class="modal-title fs-6">Definir Tipo de Obra</h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light">
              <div class="mb-3">
                <label class="form-label small fw-bold">Nombre del Tipo</label>
                <input type="text" v-model="form.nombre_tipo" class="form-control" placeholder="Ej: REMODELACI√ìN">
              </div>
              <div class="mb-3">
                <label class="form-label small fw-bold">Descripci√≥n</label>
                <textarea v-model="form.descripcion" class="form-control" rows="2"></textarea>
              </div>
              <div class="mb-3">
                <label class="form-label small fw-bold">Color Identificativo</label>
                <input type="color" v-model="form.color_representativo" class="form-control w-100 h-50">
              </div>
            </div>
            <div class="modal-footer border-0 bg-white">
              <button class="btn btn-expert w-100 rounded-pill" @click="saveGeneric('CONF_TIPO_PROYECTO')">Guardar Tipo</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal controlado por Vue (no por Bootstrap) -->
      <div v-if="showChecklistModal" class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title fs-6"><i class="bi bi-clipboard-check me-2"></i> Completar Protocolo</h5>
              <button class="btn-close btn-close-white" @click="showChecklistModal = false"></button>
            </div>
            
            <div class="modal-body bg-light" v-if="currentChecklistTask">
              
              <h6 class="fw-bold mb-3">{{ currentChecklistTask.nombre_tarea }}</h6>
              
              <div class="card border-0 shadow-sm" v-if="currentChecklistTask.respuestas_checklist">
                <div class="card-body">
                  <div v-for="(item, idx) in currentChecklistTask.respuestas_checklist" 
                      :key="idx"
                      class="mb-3 pb-3 border-bottom">
                    
                    <label class="form-label small fw-bold mb-2">
                      {{ idx + 1 }}. {{ item.label }}
                    </label>
                    
                    <!-- Checkbox -->
                    <div v-if="item.type === 'checkvalue'" class="form-check">
                      <input class="form-check-input" 
                            type="checkbox" 
                            v-model="item.value" 
                            :id="'chk_' + idx">
                      <label class="form-check-label" :for="'chk_' + idx">
                        Cumple
                      </label>
                    </div>
                    
                    <!-- Text -->
                    <input v-else-if="item.type === 'text'" 
                          type="text" 
                          v-model="item.text"
                          class="form-control form-control-sm"
                          placeholder="Ingrese respuesta...">
                    
                    <!-- Radio -->
                    <div v-else-if="item.type === 'radiobutton'" class="btn-group btn-group-sm w-100">
                      <input type="radio" class="btn-check" :name="'r'+idx" :id="'rs'+idx" value="SI" v-model="item.text">
                      <label class="btn btn-outline-success" :for="'rs'+idx">S√ç</label>
                      
                      <input type="radio" class="btn-check" :name="'r'+idx" :id="'rn'+idx" value="NO" v-model="item.text">
                      <label class="btn btn-outline-danger" :for="'rn'+idx">NO</label>
                      
                      <input type="radio" class="btn-check" :name="'r'+idx" :id="'ra'+idx" value="NA" v-model="item.text">
                      <label class="btn btn-outline-secondary" :for="'ra'+idx">N/A</label>
                    </div>
                    
                  </div>
                </div>
              </div>
              
            </div>
            
            <div class="modal-footer border-0">
              <button class="btn btn-secondary" @click="showChecklistModal = false">
                Cancelar
              </button>
              <button class="btn btn-primary" 
                      @click="saveChecklistData"
                      :disabled="!currentChecklistTask">
                <i class="bi bi-save me-2"></i>Guardar
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="modal-proyecto" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content border-0 shadow">
            
            <div class="modal-header bg-expert text-white">
              <h5 class="modal-title fs-6"><i class="bi bi-building-gear me-2"></i>Ficha de Proyecto</h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body bg-light">
              
              <div class="mb-3">
                <label class="form-label small fw-bold text-expert">Tipo de Proyecto *</label>
                  <select v-model="form.id_tipo_proyecto" class="form-select shadow-sm"> 
                    <option value="" disabled>Seleccione clasificaci√≥n...</option>
                    <option v-for="t in tipos" :key="t.id" :value="t.id">{{ t.nombre_tipo }}</option>
                  </select>
                  <div v-if="form.id && form.id_tipo_proyecto !== originalTypeId" class="alert alert-warning d-flex align-items-center mt-2 mb-0 p-2 small border-warning">
                    <i class="bi bi-exclamation-triangle-fill fs-4 me-2"></i>
                    <div class="lh-1"><strong>¬°Cuidado!</strong><br>Cambiar el tipo reiniciar√° las tareas.</div>
                  </div>
              </div>

              <div class="row g-3 mb-3">
                <div class="col-md-3"><label class="form-label small fw-bold">C√≥digo</label><input type="text" v-model="form.codigo" class="form-control"></div>
                <div class="col-md-9"><label class="form-label small fw-bold">Nombre de la Obra</label><input type="text" v-model="form.nombre_obra" class="form-control"></div>
              </div>
              
              <div class="row g-3 mb-3">
                <div class="col-md-6"><label class="form-label small fw-bold">Beneficiado</label><input type="text" v-model="form.cliente" class="form-control"></div>
                <div class="col-md-6"><label class="form-label small fw-bold">Ubicaci√≥n</label><input type="text" v-model="form.ubicacion" class="form-control"></div>
              </div>

              <div class="card border-0 shadow-sm mb-3">
                <div class="card-body bg-white rounded">
                  <div class="row g-3">
                     <div class="col-md-4"><label class="form-label small fw-bold text-muted">Fecha Inicio</label><input type="date" v-model="form.fecha_inicio" class="form-control"></div>
                     <div class="col-md-4"><label class="form-label small fw-bold text-muted">Fecha Fin</label><input type="date" v-model="form.fecha_fin" class="form-control"></div>
                     <div class="col-md-4">
                        <label class="form-label small fw-bold text-muted">Etapa Actual</label>
                        <div class="d-flex align-items-center p-2 rounded border bg-light" style="height: 38px;">
                           <div v-if="form.id" class="text-truncate fw-bold small">
                              {{ getProjectStageInfo(form.id).text }}
                           </div>
                           <div v-else class="text-muted small fst-italic">Nueva</div>
                        </div>
                     </div>
                  </div>
                </div>
              </div>

              <div v-if="currentUserProfile" class="card border-0 shadow-sm mt-3 border-start border-4 border-expert fade-in">
                  <div class="card-header bg-white border-bottom fw-bold text-expert small d-flex justify-content-between align-items-center">
                      <span>
                          <i class="bi" :class="currentUserProfile.rol_sistema === 'Admin' ? 'bi-people-fill' : 'bi-info-circle-fill'"></i>
                          {{ currentUserProfile.rol_sistema === 'Admin' ? 'Asignar Responsables' : 'Equipo Asignado' }}
                      </span>
                      <span class="badge bg-light text-dark border" v-if="form.asignados">
                          {{ form.asignados.length }} Miembros
                      </span>
                  </div>
                  
                  <div class="card-body p-0 bg-white">
                      <div class="p-2" style="max-height: 200px; overflow-y: auto;">
                      
                          <div v-if="!profesionales || profesionales.length === 0" class="text-center text-muted small py-3">
                              <i class="bi bi-person-x fs-4 d-block mb-1"></i>
                              No hay profesionales registrados.
                          </div>

                          <div v-else class="row g-2">
                              <div class="col-md-6" v-for="prof in profesionales" :key="prof.id">
                                  
                                  <div v-if="currentUserProfile.rol_sistema === 'Admin' || (form.asignados && form.asignados.includes(prof.id))">
                                      
                                      <div class="form-check w-100 m-0 p-2 border rounded bg-light d-flex align-items-center" 
                                          :class="{
                                              'border-expert bg-expert-light': form.asignados && form.asignados.includes(prof.id),
                                              'hover-card': currentUserProfile.rol_sistema === 'Admin' 
                                          }">
                                          
                                          <input class="form-check-input ms-1 me-2" type="checkbox" 
                                                :value="prof.id" 
                                                :id="'assign_'+prof.id" 
                                                v-model="form.asignados"
                                                :disabled="currentUserProfile.rol_sistema !== 'Admin'">
                                          
                                          <label class="form-check-label small flex-grow-1 lh-1" 
                                                :class="currentUserProfile.rol_sistema === 'Admin' ? 'cursor-pointer' : ''"
                                                :for="'assign_'+prof.id">
                                              <div class="fw-bold text-dark">{{ prof.nombre_completo }}</div>
                                              <span class="text-muted" style="font-size: 0.7rem;">{{ prof.rol }}</span>
                                          </label>
                                      </div>

                                  </div>
                              </div>
                              
                              <div v-if="currentUserProfile.rol_sistema !== 'Admin' && (!form.asignados || form.asignados.length === 0)" class="col-12 text-center small text-muted py-3">
                                  <i class="bi bi-people me-1"></i> No hay equipo asignado a este proyecto.
                              </div>

                          </div>

                      </div>
                  </div>
                  
                  <div class="card-footer bg-light p-2 small text-muted">
                      <span v-if="currentUserProfile.rol_sistema === 'Admin'">
                          <i class="bi bi-shield-lock me-1"></i> Control de Acceso: Solo los seleccionados ver√°n este proyecto.
                      </span>
                      <span v-else>
                          <i class="bi bi-eye-fill me-1"></i> Modo lectura: Contacta a un administrador para cambios.
                      </span>
                  </div>
              </div>

            </div>
            
            <div class="modal-footer bg-white border-0">
                <button class="btn btn-expert w-100 rounded-pill shadow-sm" @click="saveProyecto">
                    <i class="bi bi-save me-2"></i> Guardar Proyecto
                </button>
            </div>

          </div>
        </div>
      </div>

      <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item" :class="{ active: currentView === 'dashboard' }"
          @click.prevent="navigate('dashboard')"> <i class="bi" :class="currentView === 'dashboard' ? 'bi bi-grid-1x2-fill' : 'bi-grid-1x2-fill'"></i>
          <span>Inicio</span>
        </a>
        <a href="#" class="bottom-nav-item" :class="{ active: currentView === 'projects' }"
          @click.prevent="navigate('projects')"> <i class="bi" :class="currentView === 'projects' ? 'bi bi-building-fill-gear' : 'bi-building-fill-gear'"></i>
          <span>Proyectos</span>
        </a>
        <a href="#" class="bottom-nav-item" :class="{ active: currentView === 'reports' }"
          @click.prevent="navigate('reports')"
          v-if="currentUserProfile && currentUserProfile.rol_sistema === 'Admin'">
          <i class="bi bi-file-earmark-bar-graph"></i>
          <span>Reportes</span>
        </a>
        <a href="#" class="bottom-nav-item" :class="{ active: currentView === 'config' }"
          @click.prevent="navigate('config')"
          v-if="currentUserProfile && currentUserProfile.rol_sistema === 'Admin'"> <i class="bi" :class="currentView === 'config' ? 'bi bi-sliders' : 'bi-sliders2'"></i>
          <span>Configuraci√≥n</span>
        </a>
      </nav>
      </div>
    </div>
  </div>
  <script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
      setup() {
        // --- 1. ESTADO GLOBAL ---

        const isAuthorized = ref(false);
        const isLoggedIn = ref(false);
        const loading = ref(true);
        const currentView = ref('dashboard');
        const userEmail = ref('');

        const isSidebarCollapsed = ref(false);

        const currentUserProfile = ref(null);
        const asignacionesGlobal = ref([]);

        const toggleSidebar = () => {isSidebarCollapsed.value = !isSidebarCollapsed.value;};

        const proyectos = ref([]);
        const ejecucion = ref([]);
        const cargando = ref(true);

        const executionTasks = ref([]);

        const reportViewMode = ref('list'); 
        const ganttScale = ref('semester'); 

        // --- 2. DATOS MAESTROS ---
        const config = ref({ driveUrl: '' });
        const tipos = ref([]);
        const etapas = ref([]);
        const profesionales = ref([]);
        const checklists = ref([]);
        const allAsignaciones = ref([]);

        // --- 3. DATOS DE GESTI√ìN (COCKPIT) ---
        const activeProject = ref(null);
        const currentChecklistTask = ref(null); // Para controlar el modal de llenado
        const showChecklistModal = ref(false);

        // --- 4. DATOS DE TAREAS (CONFIG) ---
        const allTareas = ref([]);
        const tareasFiltradas = ref([]);
        const selectedEtapa = ref(null);
        const selectedTipoConfig = ref(null); // Para filtrar etapas en la config
        const originalTypeId = ref(null);

        // --- 5. UI ---
        const form = ref({});
        const isEditing = ref(false);
        const filterStatus = ref('all');
        let modales = {};
        const searchQuery = ref('');

        // En la secci√≥n de datos (despu√©s de searchQuery)
        const reportData = ref([]);
        const reportTipos = ref([]);
        const reportProfesionales = ref([]);
        const showFilters = ref(false);

        const reportFilters = ref({
          tipos: [],
          profesionales: [],
          fechaInicioDesde: '',
          fechaInicioHasta: '',
          fechaFinDesde: '',
          fechaFinHasta: '',
          avanceOperador: '=',
          avanceValor: null
        });

        const reportSort = ref({
          field: 'nombre',
          order: 'asc'
        });

        // Funci√≥n para cargar datos de reportes
        const loadReportData = () => {
          loading.value = true;
          google.script.run
            .withSuccessHandler(res => {
              if (res.success) {
                reportData.value = res.data;
                reportTipos.value = res.tipos;
                reportProfesionales.value = res.profesionales;
              } else {
                Swal.fire('Error', res.error, 'error');
              }
              loading.value = false;
            })
            .withFailureHandler(err => {
              loading.value = false;
              Swal.fire('Error', 'No se pudieron cargar los reportes', 'error');
            })
            .getReportData();
        };

        // --- FUNCI√ìN DE EXPORTACI√ìN A PDF ---
                const exportReportToPDF = () => {
            // 1. Validar
            if (reportProyectosFiltrados.value.length === 0) {
                Swal.fire('Atenci√≥n', 'No hay datos filtrados para exportar.', 'warning');
                return;
            }

            loading.value = true;
            
            // 2. Mapeo de datos (CORREGIDO PARA DETECTAR EL TIPO)
            const datosParaReporte = reportProyectosFiltrados.value.map(p => {
                
                // --- CORRECCI√ìN CR√çTICA AQU√ç ---
                // Buscamos el ID del tipo en todas las variantes posibles que usa tu sistema
                const idTipoReal = p.tipo_id || p.id_tipo_proyecto || p.id_tipo;
                
                // Obtenemos la info usando el ID encontrado
                const infoTipo = getProjectTypeInfo(idTipoReal);
                // -------------------------------

                // Helper para fechas
                const fmt = (d) => d ? new Date(d).toLocaleDateString('es-PY') : '';

                // Definimos el Plazo (Inicio - Fin)
                let plazoStr = '-';
                if (p.fecha_inicio && p.fecha_fin) {
                    plazoStr = `${fmt(p.fecha_inicio)} - ${fmt(p.fecha_fin)}`;
                }

                return {
                    codigo: p.codigo || '---',
                    
                    // Nombre blindado
                    nombre: p.nombre_obra || p.Nombre_Obra || p["nombre_obra "] || p.nombre || 'Sin Nombre',
                    
                    // TIPO (Ahora s√≠ deber√≠a salir)
                    tipo_nombre: infoTipo.nombre, // Esto tomar√° el nombre real (ej: "Siroques")
                    tipo_color: infoTipo.color,

                    cliente: p.cliente || '',
                    
                    // Plazo formateado
                    plazo: plazoStr,
                    
                    // Etapa Actual (stageText tiene prioridad)
                    etapa_actual: p.stageText || p.etapa_actual || p.estado || 'Planificaci√≥n',
                    etapa_color: p.stageColor || '#556B2F',

                    // Avance
                    avance: Number(p.progreso_global) || 0
                };
            });

            // Helper blindado para leer JSON desde CSV
            const parseJson = (str) => {
                // 1. Si es nulo o indefinido
                if (!str) return [];
                
                // 2. Si ya es un objeto, devolverlo
                if (typeof str === 'object') return str;

                try {
                    // Intento A: Parseo directo (el escenario ideal)
                    const parsed = JSON.parse(str);
                    
                    // Si el resultado sigue siendo un string (doble encoding), parseamos de nuevo
                    if (typeof parsed === 'string') {
                        return JSON.parse(parsed);
                    }
                    return parsed;
                } catch (e) {
                    // Intento B: Limpieza de formato CSV ("" -> ")
                    try {
                        let clean = str.trim();
                        
                        // Si empieza y termina con comillas, las quitamos
                        if (clean.startsWith('"') && clean.endsWith('"')) {
                            clean = clean.substring(1, clean.length - 1);
                        }
                        
                        // Reemplazamos las dobles comillas de CSV ("") por una simple (")
                        clean = clean.replace(/""/g, '"');
                        
                        return JSON.parse(clean);
                    } catch (e2) {
                        console.error("Error irrecuperable en JSON:", str);
                        return []; // Retorna array vac√≠o para no romper la app
                    }
                }
            };

            // 3. Llamada al Backend
            google.script.run
                .withSuccessHandler((url) => {
                    loading.value = false;
                    if (url) {
                        window.open(url, '_blank');
                        Swal.fire({
                            title: 'Reporte Generado',
                            text: 'El PDF se ha abierto en una nueva pesta√±a.',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                })
                .withFailureHandler((err) => {
                    loading.value = false;
                    console.error(err);
                    Swal.fire('Error', 'Error al generar PDF: ' + err.message, 'error');
                })
                .generatePDFReport(datosParaReporte, userEmail.value);
        };

       // --- PROPIEDAD COMPUTADA MAESTRA (FILTRO + ORDEN VISUAL) ---
        const reportProyectosFiltrados = computed(() => {
          if (!reportData.value || !Array.isArray(reportData.value)) return [];
          
          let filtered = [...reportData.value]; // Copia para no mutar original

          // --- 1. FILTROS (Se mantiene tu l√≥gica actual) ---
          if (reportFilters.value.tipos.length > 0) {
            filtered = filtered.filter(p => reportFilters.value.tipos.includes(p.tipo_id));
          }
          if (reportFilters.value.profesionales.length > 0) {
            filtered = filtered.filter(p => {
              const equipoIds = p.equipo ? p.equipo.map(e => e.id) : [];
              return reportFilters.value.profesionales.some(profId => equipoIds.includes(profId));
            });
          }
          // ... (Tus otros filtros de fecha y avance van aqu√≠ igual que antes) ...
          // Si tienes filtros de fecha/avance, aseg√∫rate de mantenerlos aqu√≠.


          // --- 2. ORDENAMIENTO INTELIGENTE (AQU√ç EST√Å LA MAGIA) ---
          const field = reportSort.value.field;
          const order = reportSort.value.order === 'asc' ? 1 : -1;

          filtered.sort((a, b) => {
            let valA, valB;

            // A) INTERCEPCI√ìN DE CAMPOS COMPLEJOS
            // Si ordenamos por TIPO, usamos el Nombre Real, no el ID
            if (field === 'tipo_id' || field === 'id_tipo_proyecto' || field === 'tipo_nombre') {
                const idA = a.tipo_id || a.id_tipo_proyecto;
                const idB = b.tipo_id || b.id_tipo_proyecto;
                valA = getProjectTypeInfo(idA).nombre || '';
                valB = getProjectTypeInfo(idB).nombre || '';
            }
            // Si ordenamos por ETAPA, usamos el texto visual (stageText)
            else if (field === 'etapa_actual' || field === 'estado') {
                valA = a.stageText || a.etapa_actual || a.estado || '';
                valB = b.stageText || b.etapa_actual || b.estado || '';
            }
            // Si ordenamos por PROGRESO
            else if (field === 'progreso_global' || field === 'avance') {
                 valA = Number(a.progreso_global) || 0;
                 valB = Number(b.progreso_global) || 0;
            }
            // B) CASO EST√ÅNDAR (Nombre, C√≥digo, Cliente, Fechas)
            else {
                valA = a[field];
                valB = b[field];
            }

            // C) NORMALIZACI√ìN PARA COMPARAR
            if (valA == null) valA = '';
            if (valB == null) valB = '';

            // Si son textos, ignorar may√∫sculas/min√∫sculas
            if (typeof valA === 'string') valA = valA.toLowerCase();
            if (typeof valB === 'string') valB = valB.toLowerCase();

            // D) COMPARACI√ìN
            if (valA < valB) return -1 * order;
            if (valA > valB) return 1 * order;
            return 0;
          });

          return filtered;
        });

        // Computed: Estad√≠sticas
        const reportTotalTareas = computed(() => {
          return reportProyectosFiltrados.value.reduce((total, p) => {
            return total + p.etapas.reduce((sum, e) => sum + e.total_tareas, 0);
          }, 0);
        });

        const reportTareasCompletadas = computed(() => {
          return reportProyectosFiltrados.value.reduce((total, p) => {
            return total + p.etapas.reduce((sum, e) => sum + e.tareas_completadas, 0);
          }, 0);
        });

        const reportAvancePromedio = computed(() => {
          if (reportProyectosFiltrados.value.length === 0) return 0;
          const suma = reportProyectosFiltrados.value.reduce((total, p) => total + p.progreso_global, 0);
          return suma / reportProyectosFiltrados.value.length;
        });

        // Helpers
        const getProyectoTotalTareas = (proyecto) => {
          return proyecto.etapas.reduce((sum, e) => sum + e.total_tareas, 0);
        };

        const getProyectoTareasCompletadas = (proyecto) => {
          return proyecto.etapas.reduce((sum, e) => sum + e.tareas_completadas, 0);
        };

        const toggleFilters = () => {
          showFilters.value = !showFilters.value;
        };

        const resetReportFilters = () => {
          reportFilters.value = {
            tipos: [],
            profesionales: [],
            fechaInicioDesde: '',
            fechaInicioHasta: '',
            fechaFinDesde: '',
            fechaFinHasta: '',
            avanceOperador: '=',
            avanceValor: null
          };
        };

        const setSortField = (field) => {
          if (reportSort.value.field === field) {
            reportSort.value.order = reportSort.value.order === 'asc' ? 'desc' : 'asc';
          } else {
            reportSort.value.field = field;
            reportSort.value.order = 'asc';
          }
        };

        const toggleSortOrder = () => {
          reportSort.value.order = reportSort.value.order === 'asc' ? 'desc' : 'asc';
        };

        // --- COMPUTED PROPERTIES ---

        // --- L√ìGICA GANTT ---

        // 1. Calcula el ancho de columna (px) seg√∫n el zoom seleccionado
        const ganttColumnWidth = computed(() => {
            switch(ganttScale.value) {
                case 'quarter': return 200; // Trimestral: Columnas anchas
                case 'semester': return 120; // Semestral: Columnas medias
                case 'year': return 60;     // Anual: Columnas estrechas (tipo p√°jaro)
                default: return 120;
            }
        });

        // 2. Determina el rango de fechas (Min y Max) de TODOS los proyectos filtrados
        const ganttRange = computed(() => {
            const proyectos = reportProyectosFiltrados.value;
            if (proyectos.length === 0) return { start: new Date(), end: new Date() };

            let min = new Date('2030-01-01');
            let max = new Date('2020-01-01');
            let hasDates = false;

            proyectos.forEach(p => {
                if (p.fecha_inicio) {
                    const d = new Date(p.fecha_inicio);
                    if (d < min) min = d;
                    hasDates = true;
                }
                if (p.fecha_fin) {
                    const d = new Date(p.fecha_fin);
                    if (d > max) max = d;
                    hasDates = true;
                }
            });

            if (!hasDates) return { start: new Date(), end: new Date() };

            // Agregar un "buffer" de 1 mes antes y despu√©s para que se vea bonito
            min = new Date(min.getFullYear(), min.getMonth() - 3, 1);
            max = new Date(max.getFullYear(), max.getMonth() + 9, 0);

            return { start: min, end: max };
        });

        // 3. Genera el array de meses para la cabecera
        const ganttTimeline = computed(() => {
            const { start, end } = ganttRange.value;
            const months = [];
            const current = new Date(start);

            while (current <= end) {
                months.push({
                    key: current.toISOString(),
                    label: current.toLocaleDateString('es-ES', { month: 'short' }).toUpperCase(), // ENE, FEB
                    year: current.getFullYear(),
                    dateObj: new Date(current) // Guardamos fecha real para c√°lculos
                });
                current.setMonth(current.getMonth() + 1);
            }
            return months;
        });


        const userInitial = computed(() => userEmail.value ? userEmail.value[0].toUpperCase() : 'U');

        const profesionalesFiltrados = computed(() => {
          if (!profesionales.value) return [];
          if (filterStatus.value === 'all') return profesionales.value;
          return profesionales.value.filter(p => p.estado === filterStatus.value);
        });

        // Filtro maestro de proyectos (Buscador Incremental + Seguridad de Rol)
        const proyectosFiltradosBuscador = computed(() => {
            // Protecci√≥n: Si proyectos no est√° listo, devolver array vac√≠o
            if (!proyectos.value || !Array.isArray(proyectos.value)) return [];
            
            // --- 1. FILTRO DE SEGURIDAD (ROL) ---
            let listaBase = proyectos.value;

            // Si el usuario existe Y NO es Admin, aplicamos el filtro de asignaci√≥n
            if (currentUserProfile.value && currentUserProfile.value.rol_sistema !== 'Admin') {
                // Obtenemos mi ID de usuario
                const myId = currentUserProfile.value.id;
                
                // Buscamos en la tabla de asignaciones todos los proyectos vinculados a m√≠
                const misProyectosIds = allAsignaciones.value
                    .filter(asignacion => asignacion.id_profesional === myId)
                    .map(asignacion => asignacion.id_proyecto); // Extraemos solo los IDs de proyecto

                // Reducimos la lista de proyectos solo a los que coinciden con esos IDs
                listaBase = listaBase.filter(p => misProyectosIds.includes(p.id));
            }

            // --- 2. FILTRO DE B√öSQUEDA (TEXTO) ---
            // Ahora aplicamos el buscador sobre la lista ya filtrada (o completa si es Admin)
            if (!searchQuery.value) return listaBase;
            
            const q = searchQuery.value.toLowerCase().trim();
            return listaBase.filter(p => {
                return (p.nombre_obra || '').toLowerCase().includes(q) ||
                       (p.codigo || '').toLowerCase().includes(q) ||
                       (p.cliente || '').toLowerCase().includes(q) ||
                       (p.ubicacion || '').toLowerCase().includes(q) ||
                       (p.estado || '').toLowerCase().includes(q);
            });
        });


        // --- HELPER GANTT: Calcular posici√≥n CSS ---
        const getGanttBarStyle = (p) => {
            if (!p.fecha_inicio || !p.fecha_fin) return {};

            const rangeStart = ganttRange.value.start;
            const start = new Date(p.fecha_inicio);
            const end = new Date(p.fecha_fin);
            
            // 1. Calcular diferencia en milisegundos desde el inicio del gr√°fico
            const diffStart = start - rangeStart;
            const duration = end - start;

            // 2. Convertir a "Meses" aproximados para multiplicar por el ancho de columna
            // Un mes promedio = 30.44 d√≠as = 2629746000 ms
            const msPerMonth = 2629746000;
            
            // Posici√≥n Left (en px)
            const leftPx = (diffStart / msPerMonth) * ganttColumnWidth.value;
            
            // Ancho (en px)
            let widthPx = (duration / msPerMonth) * ganttColumnWidth.value;
            if (widthPx < 5) widthPx = 5; // M√≠nimo visible

            // Color del proyecto
            const color = p.tipo_color || '#556B2F';

            return {
                left: `${leftPx}px`,
                width: `${widthPx}px`,
                backgroundColor: color
            };
        };

        // --- UTILIDADES ---        
        
        const dashboardIds = computed(() => {
            return proyectosFiltradosBuscador.value.map(p => p.id);
        });

        const dashTotalTareas = computed(() => {
            if (!executionTasks.value) return 0;
            // Filtramos tareas que pertenezcan a los proyectos visibles actualmente
            return executionTasks.value.filter(t => dashboardIds.value.includes(t.proyecto_id)).length;
        });

        const dashTareasCompletadas = computed(() => {
            if (!executionTasks.value) return 0;
            return executionTasks.value.filter(t => 
                dashboardIds.value.includes(t.proyecto_id) && 
                t.estado === 'Completado'
            ).length;
        });

        const dashAvancePromedio = computed(() => {
             // Opci√≥n A: Promedio simple basado en tareas totales vs completadas (M√°s preciso globalmente)
             if (dashTotalTareas.value === 0) return 0;
             return (dashTareasCompletadas.value / dashTotalTareas.value) * 100;
        });

        // 1. Verifica si una tarea tiene evidencia v√°lida (sin romper la app)
        const hasValidEvidence = (task) => {
            if (!task || !task.datos_evidencia) return false;
            try {
                const str = String(task.datos_evidencia).trim();
                // Verifica que sea texto largo y no sea la palabra "null"
                return str.length > 5 && str.toLowerCase() !== 'null' && str.toLowerCase() !== 'undefined';
            } catch (e) {
                return false;
            }
        };

        // Funci√≥n para calcular progreso individual en el listado
        const calculateProjectProgress = (projectId) => {
            // Usamos executionTasks que ya tiene todas las tareas cargadas
            if (!executionTasks.value) return 0;
            
            const tasks = executionTasks.value.filter(t => t.proyecto_id === projectId);
            if (tasks.length === 0) return 0;
            
            const completed = tasks.filter(t => t.estado === 'Completado').length;
            return Math.round((completed / tasks.length) * 100);
        };

        // 2. Cuenta los items de un checklist de forma segura
        const getChecklistCount = (jsonStr) => {
            try {
                const items = parseJson(jsonStr);
                return Array.isArray(items) ? items.length : 0;
            } catch (e) {
                return 0;
            }
        };

        // 3. Verifica si la lista de items del modal est√° vac√≠a
        const isModalItemsEmpty = (items) => {
            if (!items) return true;
            if (!Array.isArray(items)) return true;
            return items.length === 0;
        };

        // 3. Funci√≥n CORREGIDA para verificar datos de checklist (Arregla error de .trim() en n√∫meros)
        const hasChecklistData = (t) => {
            if (!t) return false;
            const data = t.datos_checklist || t.datos_evidencia;
            if (!data) return false;
            // CORRECCION: Convertimos a String antes de usar .trim() para evitar crash con N√∫meros
            return String(data).trim().startsWith('[');
        };

        // Obtiene nombre y color del tipo de proyecto
        const getProjectTypeInfo = (idType) => {
           if (!idType) return { nombre: 'Sin Tipo', color: '#6c757d' };
           const t = tipos.value.find(type => type.id === idType);
           // Retornamos el objeto o un fallback si no se encuentra
           return t ? { nombre: t.nombre_tipo, color: t.color_representativo || '#556B2F' } 
                    : { nombre: 'Desconocido', color: '#333' };
        };

        // --- SUBIDA DE ARCHIVOS ---
        const triggerFileUpload = (task) => {
           const el = document.getElementById('fileInput_' + task.id);
           if(el) el.click();
        };

        const handleFileUpload = (event, task) => {
           const file = event.target.files[0];
           if (!file) return;

           // Validaci√≥n frontend de tama√±o (ej. 10MB)
           if (file.size > 10 * 1024 * 1024) {
              Swal.fire('Archivo muy grande', 'El l√≠mite es 10MB', 'warning');
              return;
           }

           loading.value = true;
           const reader = new FileReader();
           
           reader.onload = function(e) {
              // Obtenemos base64 puro (sin el encabezado data:...)
              const content = e.target.result.split(',')[1]; 
              
              google.script.run
                 .withSuccessHandler((res) => {
                    loading.value = false;
                    // Actualizamos modelo local
                    task.datos_evidencia = res.url;
                    
                    // Si ya tiene checklist (o no requiere) y ahora tiene archivo, quiz√°s podamos completar
                    Swal.fire({
                       title: 'Archivo Cargado',
                       text: 'La evidencia se guard√≥ en Drive correctamente.',
                       icon: 'success',
                       timer: 2000
                    });
                 })
                 .withFailureHandler(err => {
                    loading.value = false;
                    Swal.fire('Error', 'No se pudo subir el archivo: ' + err.message, 'error');
                 })
                 .uploadTaskEvidence(task.id, content, file.name, file.type);
           };
           
           reader.readAsDataURL(file);
        };

        // --- AJUSTE EN saveChecklistData ---
        const saveChecklistData = () => {
            const t = currentChecklistTask.value;
            
            if (!t || !t.respuestas_checklist) {
                Swal.fire('Error', 'No hay datos para guardar', 'error');
                return;
            }
            
            const jsonRespuestas = JSON.stringify(t.respuestas_checklist);
            t.datos_checklist = jsonRespuestas;
            
            loading.value = true;
            google.script.run
                .withSuccessHandler(() => {
                    loading.value = false;
                    showChecklistModal.value = false; // ‚≠ê CAMBIO: Cerrar con Vue
                    
                    if (!t.requiere_evidencia) {
                        t.estado = 'Completado';
                        updateTask(t);
                        Swal.fire('Completado', 'Checklist guardado y tarea finalizada.', 'success');
                    } else {
                        Swal.fire('Guardado', 'Checklist registrado. Recuerda subir la evidencia.', 'info');
                    }
                })
                .withFailureHandler(err => {
                    loading.value = false;
                    Swal.fire('Error', 'No se pudo guardar: ' + err.message, 'error');
                })
                .updateExecutionTask({
                    id: t.id,
                    datos_checklist: jsonRespuestas
                });
        };

        // Convierte ISO String a YYYY-MM-DD para inputs HTML5
        const toInputDate = (val) => {
           if (!val) return '';
           const date = new Date(val);
           if (isNaN(date.getTime())) return ''; // Si es inv√°lida, retornar vac√≠o
           return date.toISOString().split('T')[0];
        };

        // Calcula cu√°ntos proyectos no est√°n terminados o archivados
        const totalPendientes = computed(() => {
            // 1. Verificamos que .value exista
            const tareas = executionTasks.value;
            if (!executionTasks.value) return 0; 
            if (!tareas || !Array.isArray(tareas)) return 0;
            
            // 2. Filtramos de forma segura
            return executionTasks.value.filter(t => t && t.estado !== 'Completado').length;
        });

        const etapasFiltradasPorTipo = computed(() => {
          if (!selectedTipoConfig.value) return [];
          return (etapas.value || []).filter(e => e.id_tipo_proyecto === selectedTipoConfig.value);
        });

        const tareasFiltradasLength = computed(() => {
          if (!tareasFiltradas.value || !Array.isArray(tareasFiltradas.value)) return 0;
          return tareasFiltradas.value.length;
        });

        // Helper para obtener el estado calculado de un proyecto espec√≠fico por ID
        const getProjectStageInfo = (id) => {
           const p = proyectos.value.find(x => x.id === id);
           if (p) {
             return { text: p.stageText, color: p.stageColor };
           }
           return { text: 'Planificaci√≥n', color: '#999' };
        };

        // Funci√≥n para obtener los profesionales de un proyecto espec√≠fico
        const getProjectTeam = (projectId) => {
            // Protecci√≥n contra cargas vac√≠as
            if (!allAsignaciones.value || !profesionales.value) return [];
            
            // 1. Filtrar las relaciones de este proyecto
            const assignedIds = allAsignaciones.value
                .filter(a => a.id_proyecto === projectId)
                .map(a => a.id_profesional);
            
            // 2. Mapear a los objetos completos de profesionales
            return profesionales.value.filter(p => assignedIds.includes(p.id));
        };

        // Estructura del proyecto activo (Agrupa tareas por etapa)
        const projectStructure = computed(() => {
            if (!activeProject.value) return [];
            // Validamos que etapas sea un array y tenga longitud
            if (!etapas.value || !Array.isArray(etapas.value) || etapas.value.length === 0) return [];

            return etapas.value.map(etapa => {
                // Protecci√≥n extra para executionTasks
                const tasks = (executionTasks.value || []).filter(t => t && t.id && t.etapa_id === etapa.id);
                if (tasks.length === 0) return null;

                const completadas = tasks.filter(t => t.estado === 'Completado').length;
                const progreso = tasks.length > 0 ? Math.round((completadas / tasks.length) * 100) : 0;

                return { ...etapa, tasks, progress: progreso };
            }).filter(e => e !== null);
        });

        const globalProgress = computed(() => {
          if (!executionTasks.value || executionTasks.value.length === 0) return 0;
          const completadas = executionTasks.value.filter(t => t && t.estado === 'Completado').length;
          return Math.round((completadas / executionTasks.value.length) * 100);
        });

        const login = () => {
          loading.value = true;
          
          // Llamamos directamente a buscar el perfil
          google.script.run
            .withSuccessHandler(async (profile) => {
              
              // CASO A: USUARIO NO ENCONTRADO EN EXCEL
              if (!profile) {
                loading.value = false;
                isLoggedIn.value = true; // Est√° logueado en Google...
                isAuthorized.value = false; // ...pero NO autorizado en la App
                userEmail.value = "Usuario no registrado";                
                return; 
              }

              // CASO B: USUARIO V√ÅLIDO
              currentUserProfile.value = profile; // Guardamos todo el perfil (Nombre, Rol, ID)
              userEmail.value = profile.email;
              isLoggedIn.value = true;
              isAuthorized.value = true;
              loading.value = false;

              // Esperamos al DOM y cargamos datos
              await nextTick();
              
              // Inicializar modales
              ['etapa', 'profesional', 'proyecto', 'checklist', 'fillChecklist', 'tipo'].forEach(id => {
                  const el = document.getElementById('modal-' + id);
                  if (el) modales[id] = new bootstrap.Modal(el);
              });

              loadData(); // Carga el resto de la app
            })
            .withFailureHandler(err => {
              loading.value = false;
              Swal.fire('Error de Conexi√≥n', err.message, 'error');
            })
            .getCurrentUserProfile();
        };

        const logout = () => { isLoggedIn.value = false; currentView.value = 'projects'; }; // Logout va a projects por seguridad

        const navigate = (view) => {
          currentView.value = view;
          if (view === 'projects') activeProject.value = null;
          
          // Cargar datos de reportes cuando se accede
          if (view === 'reports') {
            loadReportData();
          } else {
            loadData();
          }
        };

        // --- CARGA DE DATOS ---
        const loadData = async () => {
          loading.value = true;
          console.time("CargaTotal"); // Para medir rendimiento en consola

          try {
              // --- HELPERS ---
              const load = (s) => new Promise(r => {
                  google.script.run
                      .withSuccessHandler(res => r(Array.isArray(res) ? res : []))
                      .withFailureHandler(err => {
                          console.error(`Fallo carga de ${s}`, err);
                          r([]); // Fallback seguro
                      })
                      .readConfig(s);
              });

              // --- 1. CARGA PARALELA MASIVA (CORE DATA) ---
              const [
                  resProyectos,
                  resTipos,
                  resEtapas,
                  resEjecucion,
                  resProfesionales,
                  resGen,
                  resSecureProjects,
                  resAsignaciones,  
                  resPerfil,
                  resProgressStats,
                  resChecklists,     // ‚úÖ NUEVO: Carga s√≠ncrona de checklists
                  resTareas          // ‚úÖ NUEVO: Carga s√≠ncrona de tareas
              ] = await Promise.all([
                  load("DB_PROYECTOS"),
                  load("CONF_TIPO_PROYECTO"),
                  load("CONF_ETAPAS"),
                  load("DB_EJECUCION"), 
                  load("CONF_PROFESIONALES"),
                  load("CONF_GENERAL"),
                  new Promise(r => google.script.run.withSuccessHandler(r).getSecureProjects()),
                  load("CONF_REL_ASIGNACIONES"),
                  new Promise(r => google.script.run.withSuccessHandler(r).getCurrentUserProfile()),
                  new Promise(r => google.script.run.withSuccessHandler(r).getGlobalProgressStats()),
                  load("CONF_CHECKLISTS"),  // ‚úÖ CR√çTICO: Cargar checklists de forma s√≠ncrona
                  load("CONF_TAREAS")        // ‚úÖ CR√çTICO: Cargar tareas de forma s√≠ncrona
              ]);

              // Asignaciones
              currentUserProfile.value = resPerfil;
              const misProyectos = resSecureProjects || [];

              // IMPORTANTE: Guardamos las asignaciones en una variable global para usar en el modal
              allAsignaciones.value = resAsignaciones || [];
              
              // --- 2. ASIGNACI√ìN DE MAESTROS (CON DOBLE PROTECCI√ìN || []) ---
              tipos.value = resTipos || []; 
              
              // Protecci√≥n vital para el sort:
              etapas.value = (resEtapas || []).sort((a, b) => (Number(a.orden) || 0) - (Number(b.orden) || 0));

              profesionales.value = resProfesionales || []; 
              executionTasks.value = resEjecucion || [];

              // ‚úÖ CR√çTICO: Asignar checklists y tareas de forma s√≠ncrona
              checklists.value = resChecklists || [];
              allTareas.value = (resTareas || []).map(t => ({
                  ...t,
                  requiere_evidencia: String(t.requiere_evidencia).toLowerCase() === 'true',
                  tipo_entrada: t.tipo_entrada || 'text',
                  checklist_id: t.checklist_id || ''
              }));
              
              profesionales.value = resProfesionales || []; 
              executionTasks.value = resEjecucion || [];

              // ‚≠ê CR√çTICO: Asignar checklists de forma s√≠ncrona
              checklists.value = resChecklists || [];
              console.log(`üìã Checklists cargados: ${checklists.value.length}`);
              
              allTareas.value = (resTareas || []).map(t => ({
                  ...t,
                  requiere_evidencia: String(t.requiere_evidencia).toLowerCase() === 'true',
                  tipo_entrada: t.tipo_entrada || 'text',
                  checklist_id: t.checklist_id || ''
              }));

              // --- 3. CONFIGURACI√ìN GENERAL ---
              const driveData = resGen || [];
              const dUrl = driveData.find(p => p.parametro === 'DRIVE_ROOT_FOLDER_URL');
              config.value.driveUrl = dUrl ? dUrl.valor : '';

              // --- 4. PROCESAMIENTO DE PROYECTOS CON C√ÅLCULO DIN√ÅMICO ---
              proyectos.value = (resProyectos || []).reverse().map(p => {
                  // ‚úÖ NUEVO: Obtener estad√≠sticas calculadas din√°micamente desde el backend
                  const stats = resProgressStats ? resProgressStats[p.id] : null;
                  
                  if (stats) {
                      // Usar datos calculados basados en el progreso real de tareas
                      return {
                          ...p,
                          stageText: stats.stageText,      // ‚Üê Etapa actual calculada
                          stageColor: stats.stageColor     // ‚Üê Color din√°mico
                      };
                  } else {
                      // Fallback: Proyecto sin tareas o sin estad√≠sticas
                      return {
                          ...p,
                          stageText: 'Planificaci√≥n',
                          stageColor: '#999'
                      };
                  }
              });

              // --- 5. LOGICA DE NEGOCIO POR DEFECTO ---
              if (tipos.value && Array.isArray(tipos.value) && tipos.value.length > 0 && !selectedTipoConfig.value) {
                  selectedTipoConfig.value = tipos.value[0].id;
              }

              } catch (e) {
                  console.error("CRITICAL ERROR IN LOAD_DATA:", e);
                  Swal.fire({
                      icon: 'error',
                      title: 'Error de Conexi√≥n',
                      text: 'No se pudieron cargar los datos. Por favor recarga la p√°gina.'
                  });
              } finally {
                  console.timeEnd("CargaTotal");
                  loading.value = false;
              }
        };

        const saveProyecto = () => {
          // 1. Validaciones
          if (!form.value.nombre_obra || !form.value.codigo) {
             return Swal.fire('Faltan datos', 'El nombre y c√≥digo son obligatorios', 'warning');
          }

          loading.value = true;

          // 2. Preparar los datos
          const projectData = JSON.parse(JSON.stringify(form.value));
          const asignadosList = form.value.asignados || []; 
          delete projectData.asignados;

          // ‚úÖ CAPTURAR TIMESTAMP ACTUAL PARA VALIDACI√ìN DE CONCURRENCIA
          if (!projectData.id) {
            // Proyecto nuevo - no necesita timestamp de validaci√≥n
            projectData.created_at = new Date().toISOString();
          } else {
            // Proyecto existente - mantener updated_at para validaci√≥n
            // (El backend lo comparar√° con el de la BD)
          }

          // 3. L√≥gica de Guardado

          // CASO A: CAMBIO DE TIPO DE PROYECTO (Acci√≥n Destructiva)
          // Si es edici√≥n (tiene ID) Y el tipo cambi√≥ respecto al original
          if (projectData.id && projectData.id_tipo_proyecto !== originalTypeId.value) {
            loading.value = false; // Pausamos loading para preguntar
            
            Swal.fire({
                title: '¬øCambiar Tipo de Proyecto?',
                html: `Est√°s pasando de un tipo a otro.<br><br>
                       <b class="text-danger">ESTO REINICIAR√Å TODAS LAS TAREAS</b><br>
                       y borrar√° las evidencias actuales.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'S√≠, cambiar y reiniciar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    loading.value = true;
                    // Nota: En este caso espec√≠fico priorizamos el reset de estructura.
                    // Las asignaciones se mantendr√°n como estaban antes del cambio.
                    google.script.run
                        .withSuccessHandler(() => {
                            modales.proyecto.hide();
                            loadData();
                            Swal.fire('Actualizado', 'El proyecto se ha reconfigurado y reiniciado.', 'success');
                        })
                        .withFailureHandler(err => {
                            loading.value = false;
                            Swal.fire('Error', err.message, 'error');
                        })
                        .updateProjectTypeAndReset(projectData.id, projectData.id_tipo_proyecto);
                }
            });
          } 
          
          // CASO B: GUARDADO EST√ÅNDAR (Crear Nuevo o Editar Datos/Equipo)
          else {
            // Llamamos a la NUEVA funci√≥n del backend que maneja la transacci√≥n doble
            google.script.run
              .withSuccessHandler((res) => {
                modales.proyecto.hide();
                loadData(); // Recargamos para aplicar los filtros de seguridad nuevos
                loading.value = false;
                
                const msg = projectData.id ? 'Cambios guardados' : 'Proyecto creado y equipo asignado';
                Swal.fire('√âxito', msg, 'success');
              })
              .withFailureHandler(e => {
                loading.value = false;
                
                // Manejo especial para conflictos de concurrencia
                if (e.message.includes('CONFLICTO')) {
                  Swal.fire({
                    icon: 'warning',
                    title: 'Conflicto Detectado',
                    html: e.message,
                    confirmButtonText: 'Recargar Datos',
                    showCancelButton: true,
                    cancelButtonText: 'Cancelar'
                  }).then((result) => {
                    if (result.isConfirmed) {
                      // Recargar datos del proyecto
                      modales.proyecto.hide();
                      loadData();
                    }
                  });
                } 
                // Manejo especial para locks
                else if (e.message.includes('est√° siendo editado')) {
                  Swal.fire({
                    icon: 'info',
                    title: 'Proyecto Ocupado',
                    text: e.message,
                    confirmButtonText: 'Entendido',
                    timer: 5000
                  });
                }
                // Otros errores
                else {
                  Swal.fire('Error', 'No se pudo guardar: ' + e.message, 'error');
                }
              })
              .saveProjectWithAssignments(projectData, asignadosList);
          }
        };

        const deleteProject = (p) => {
          Swal.fire({
            title: '¬øBorrar Proyecto?',
            text: 'Se eliminar√° la carpeta de Drive y todas las tareas.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33'
          }).then(r => {
            if (r.isConfirmed) {
              loading.value = true;
              google.script.run.withSuccessHandler(() => {
                loadData();
                loading.value = false;
                Swal.fire('Eliminado', '', 'success');
              }).deleteProjectFull(p.id);
            }
          });
        };

        // --- REINICIO TOTAL DE PROYECTO (RESET) ---
        const resetProject = (p) => {
          Swal.fire({
            title: 'Reiniciar toda la gesti√≥n del Proyecto?',
            html: `
                    <div class="text-start">
                      <p>Est√°s a punto de resetear: <b>${p.nombre_obra}</b>.</p>
                      <div class="alert alert-danger mb-0" role="alert">
                        <h6 class="alert-heading fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> ACCI√ìN DESTRUCTIVA</h6>
                        <ul class="small mb-0 ps-3">
                          <li>Se borrar√° la <b>Carpeta de Drive</b> y todos sus archivos.</li>
                          <li>Se borrar√°n todas las <b>fotos y documentos</b> cargados.</li>
                          <li>Se reiniciar√° el progreso al 0%.</li>
                          <li>Se crear√° una estructura de carpetas nueva y vac√≠a.</li>
                        </ul>
                      </div>
                      <p class="mt-2 text-center small text-muted">Esta acci√≥n no se puede deshacer.</p>
                    </div>
                  `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Eliminar',
            cancelButtonText: 'Cancelar',
            focusCancel: true
          }).then((result) => {
            if (result.isConfirmed) {
              loading.value = true;
              google.script.run
                .withSuccessHandler(() => {
                  loading.value = false;
                  if (activeProject.value && activeProject.value.id === p.id) {
                    activeProject.value = null;
                    executionTasks.value = [];
                  }
                  loadData();
                  Swal.fire('Proyecto Reiniciado', 'Drive y Tareas han sido regenerados.', 'success');
                })
                .withFailureHandler(err => {
                  loading.value = false;
                  Swal.fire('Error', 'Fallo al reiniciar: ' + err.message, 'error');
                })
                .regenerateProjectTasks(p.id);
            }
          });
        };

        const openProjectDetail = (p) => {
          activeProject.value = p;
          loading.value = true;
          executionTasks.value = []; // Limpiar antes de cargar

          google.script.run
            .withSuccessHandler(tasks => {
              if (!Array.isArray(tasks)) tasks = [];

              executionTasks.value = tasks
                .filter(t => t && t.id)
                .map(t => ({
                    id: t.id,
                    etapa_id: t.etapa_id,
                    proyecto_id: t.proyecto_id,
                    nombre_tarea: t.nombre_tarea || 'Sin nombre',
                    requiere_evidencia: (String(t.requiere_evidencia).toLowerCase() === 'true'),
                    evidencia_url: t.evidencia_url || '',
                    tipo_entrada: t.tipo_entrada || 'text',
                    checklist_id: t.checklist_id || '',
                    estado: t.estado || 'Pendiente',
                    comentarios: (t.comentarios === null || t.comentarios === undefined) ? '' : t.comentarios,

                    // --- CORRECCI√ìN DE TIPOS DE DATOS ---
                    // 1. Aseguramos que la evidencia sea siempre un String (texto)
                    datos_evidencia: t.datos_evidencia ? String(t.datos_evidencia) : '',

                    // 2. Aseguramos que el checklist se lea de su columna correcta
                    datos_checklist: t.datos_checklist ? String(t.datos_checklist) : '',

                    // 3. Parseamos el checklist desde su columna espec√≠fica
                    respuestas_checklist: (t.datos_checklist && String(t.datos_checklist).trim().startsWith('[')) 
                                          ? JSON.parse(t.datos_checklist) 
                                          : null
                }));

              currentView.value = 'project-detail';
              loading.value = false;
            })
            .withFailureHandler(err => {
              loading.value = false;
              console.error(err);
              Swal.fire("Error", "Error cargando tareas", "error");
            })
            .getProjectExecutionData(p.id);
        };

        const updateTask = (task) => {
          if (!task || !task.id) return;
          google.script.run.updateExecutionTask({
            id: task.id,
            estado: task.estado,
            comentarios: task.comentarios || '',
            datos_evidencia: task.datos_evidencia || '' // Guardamos JSON de respuestas
          });
        };

        // --- L√ìGICA DE VALIDACI√ìN Y ESTADO ---
        const toggleTaskState = (task) => { 
            if (!task) return;
            
            // 1. Si ya est√° completado, permitir volver a pendiente
            if (task.estado === 'Completado') {
                task.estado = 'Pendiente';
                updateTask(task);
                return;
            }

            // 2. VALIDACI√ìN DE EVIDENCIA (Archivo)
            if (task.requiere_evidencia) {
                // Verificamos si hay URL en datos_evidencia
                const tieneArchivo = task.datos_evidencia && task.datos_evidencia.startsWith('http');
                if (!tieneArchivo) {
                    Swal.fire('Falta Evidencia', 'Debes adjuntar el archivo obligatorio para completar esta tarea.', 'warning');
                    return; // BLOQUEO
                }
            }

            // 3. VALIDACI√ìN DE CHECKLIST
            if (task.checklist_id) {
                if (hasChecklistData(task)) {
                    // Todo ok
                } else {
                    Swal.fire({
                        title: 'Protocolo Requerido',
                        text: 'Completa el checklist antes de finalizar.',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'Llenar'
                    }).then(r => { if(r.isConfirmed) openFillChecklist(task); });
                    return; // BLOQUEO
                }
            }

            // Si pasa todas las validaciones
            task.estado = 'Completado';
            updateTask(task); 
        };
        
        const openFillChecklist = (task) => {
    // 1. Validar checklist_id
    if (!task.checklist_id) {
        Swal.fire('Error', 'Esta tarea no tiene un protocolo asignado', 'error');
        return;
    }
    
    // 2. Validar que checklists est√©n cargados
    if (!checklists.value || checklists.value.length === 0) {
        Swal.fire({
            title: 'Cargando configuraci√≥n...',
            showConfirmButton: false,
            allowOutsideClick: false
        });
        
        google.script.run
            .withSuccessHandler(res => {
                Swal.close();
                checklists.value = res || [];
                openFillChecklist(task);
            })
            .withFailureHandler(err => {
                Swal.close();
                Swal.fire('Error', 'No se pudieron cargar los checklists', 'error');
            })
            .readConfig("CONF_CHECKLISTS");
        return;
    }
    
    // 3. Buscar definici√≥n
    const def = checklists.value.find(c => c.id === task.checklist_id);
    if (!def) {
        Swal.fire('Error', 'Checklist no encontrado', 'error');
        return;
    }
    
    // 4. Parsear items
    let items = [];
    try {
        items = parseJson(def.config_json);
        if (!Array.isArray(items) || items.length === 0) {
            throw new Error("Checklist vac√≠o");
        }
    } catch (e) {
        Swal.fire('Error', 'El checklist tiene un formato inv√°lido', 'error');
        return;
    }
    
    // 5. Preparar respuestas
    let respuestas = [];
    if (!task.respuestas_checklist || task.respuestas_checklist.length === 0) {
        respuestas = items.map(item => ({
            label: item.label,
            type: item.type,
            value: false, 
            text: ''      
        }));
    } else {
        respuestas = [...task.respuestas_checklist];
    }
    
    // ‚≠ê NUEVO: Preparar TODO antes de mostrar
    currentChecklistTask.value = {
        id: task.id,
        nombre_tarea: task.nombre_tarea,
        checklist_id: task.checklist_id,
        estado: task.estado,
        requiere_evidencia: task.requiere_evidencia,
        datos_checklist: task.datos_checklist,
        respuestas_checklist: respuestas
    };
    
    // ‚≠ê AHORA S√ç, mostrar el modal (controlado por Vue)
    showChecklistModal.value = true;
};

        // Funci√≥n auxiliar blindada para abrir el modal
        const prepareAndShowModal = (task, def) => {
            // 1. L√≥gica de preparaci√≥n de datos (Igual que antes)
            if (!task.respuestas_checklist || task.respuestas_checklist.length === 0) {
                const items = parseJson(def.config_json);
                if (items.length === 0) {
                    Swal.fire('Atenci√≥n', 'Este checklist est√° vac√≠o. Config√∫ralo en "Ajustes".', 'warning');
                    return;
                }
                task.respuestas_checklist = items.map(item => ({
                    label: item.label,
                    type: item.type,
                    value: false, 
                    text: ''      
                }));
            }
            currentChecklistTask.value = task;

            // 2. CORRECCI√ìN CR√çTICA: Inicializaci√≥n perezosa (Lazy Load)
            // Si modales.fillChecklist no existe, lo buscamos en el DOM y lo creamos ahora mismo
            if (!modales.fillChecklist) {
                const el = document.getElementById('modal-fillChecklist');
                if (el) {
                    modales.fillChecklist = new bootstrap.Modal(el);
                } else {
                    console.error("ERROR CR√çTICO: No se encuentra el elemento <div id='modal-fillChecklist'> en el HTML.");
                    Swal.fire('Error de Sistema', 'No se encuentra el c√≥digo HTML del modal de checklist.', 'error');
                    return;
                }
            }

            // 3. Ahora es seguro mostrarlo
            modales.fillChecklist.show();
        };

        // --- CONFIGURACI√ìN DE TAREAS ---
        const selectEtapa = (e) => { 
          selectedEtapa.value = e; 
          if (e && e.id) {
            filterTareasForStage(e.id);
          } else {
            tareasFiltradas.value = [];
          }
        };

        const filterTareasForStage = (id) => {
          const tareasBase = Array.isArray(allTareas.value) ? allTareas.value : [];
          
          tareasFiltradas.value = tareasBase
            .filter(t => t.etapa_id === id)
            .map(t => ({ ...t }));
        };

        const addTareaLocal = () => {
          if (selectedEtapa.value) {
            tareasFiltradas.value.push({
              id: '',
              etapa_id: selectedEtapa.value.id,
              nombre_tarea: '',
              requiere_evidencia: false,
              tipo_entrada: 'text', // Default
              checklist_id: '',     // Default
              created_at: null
            });
          }
        };

        const saveTareasBatch = async () => {
          loading.value = true;
          for (let t of tareasFiltradas.value) {
            const tareaLimpia = JSON.parse(JSON.stringify(t));
            await new Promise(r => google.script.run.withSuccessHandler(r).saveConfigRecord("CONF_TAREAS", tareaLimpia));
          }
          await loadData();
          loading.value = false;
          Swal.fire('Guardado', '', 'success');
        };

        const removeTareaLocal = (idx, id) => {
          if (!id) tareasFiltradas.value.splice(idx, 1);
          else {
            google.script.run.withSuccessHandler(() => {
              tareasFiltradas.value.splice(idx, 1);
              allTareas.value = allTareas.value.filter(t => t.id !== id);
            }).deleteConfigRecord('CONF_TAREAS', id);
          }
        };

        // --- CORRECCI√ìN EN EL SCRIPT (Al final del archivo Index.html) ---
        const parseJson = (str) => {
          // 1. Si no hay dato, devolver array vac√≠o inmediatamente
          if (str === undefined || str === null || str === '') return [];
          
          // 2. Si ya es un objeto (y no es null), devolverlo
          if (typeof str === 'object') return str;
          
          try {
            // 3. Parsear
            const result = JSON.parse(str);
            // 4. Si el resultado es null (ej. string "null"), devolver array vac√≠o
            return result || [];
          } catch (e) {
            // 5. Intentar limpieza si falla el parseo normal
            try {
              let clean = String(str).replace(/^"|"$/g, '').replace(/""/g, '"');
              const res2 = JSON.parse(clean);
              return res2 || [];
            } catch (e2) {
              return []; // En caso de error total, devolver array vac√≠o
            }
          }
        };
        const addChecklistItem = () => {
          if (!form.value.items) form.value.items = [];
          form.value.items.push({ label: '', type: 'checkvalue' });
          nextTick(() => {
            const container = document.getElementById('sortable-items');
            if (container) container.scrollTop = container.scrollHeight;
          });
        };

        const saveChecklist = () => {
          if (!form.value.nombre_checklist) return Swal.fire('Atenci√≥n', 'Ponle un nombre', 'warning');
          if (!form.value.items || form.value.items.length === 0) return Swal.fire('Atenci√≥n', 'Agrega √≠tems', 'warning');
          form.value.config_json = JSON.stringify(form.value.items);
          saveGeneric('CONF_CHECKLISTS');
        };

        // --- UTILIDADES ---
        const saveGeneric = (sheet) => {
          loading.value = true;
          google.script.run.withSuccessHandler(() => {
            Object.values(modales).forEach(m => m && m.hide());
            loadData();
            Swal.fire({ title: 'Guardado', icon: 'success', timer: 1000, showConfirmButton: false });
            loading.value = false;
          }).saveConfigRecord(sheet, form.value);
        };

        const saveDriveUrl = () => {
          loading.value = true;
          google.script.run.withSuccessHandler(() => {
            loading.value = false;
            Swal.fire('Guardado', '', 'success');
          }).updateDriveUrl(config.value.driveUrl);
        };

        const deleteRecord = (s, id) => {
          Swal.fire({
            title: '¬øConfirmar eliminaci√≥n?',
            text: "Esta acci√≥n no se puede deshacer.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'S√≠, borrar',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              loading.value = true;
              
              google.script.run
                .withSuccessHandler((response) => {
                  loading.value = false;
                  
                  if (response.success) {
                    // √âxito: Notificar y recargar
                    Swal.fire(
                      '¬°Eliminado!',
                      response.message,
                      'success'
                    );
                    loadData(); // Recargamos la tabla
                  } else {
                    // Error de l√≥gica (Dependencias)
                    Swal.fire({
                      title: 'Operaci√≥n Bloqueada',
                      text: response.message, // Aqu√≠ mostramos "Usado en otra tabla..."
                      icon: 'error',
                      confirmButtonColor: '#556B2F'
                    });
                  }
                })
                .withFailureHandler((error) => {
                  loading.value = false;
                  Swal.fire('Error', 'Error de comunicaci√≥n con el servidor.', 'error');
                })
                .deleteConfigRecord(s, id);
            }
          });
        };

        const toggleStatus = (p) => {
          let updatedP = { ...p, estado: 'Inactivo' };
          loading.value = true;
          google.script.run.withSuccessHandler(() => {
            loadData();
            Swal.fire('Archivado', 'Profesional desactivado.', 'info');
          }).saveConfigRecord('CONF_PROFESIONALES', updatedP);
        };

        const formatCurrency = (value) => {
          if (!value) return '-';
          return new Intl.NumberFormat('es-PY', { style: 'currency', currency: 'PYG' }).format(value);
        };

        /**
         * openModal - Versi√≥n GAS Expert Pro
         * Gestiona la apertura din√°mica de m√∫ltiples tipos de formularios.
         */
        const openModal = (t, d = null) => {
          console.log(`[GAS Expert] Abriendo modal: ${t} | Modo: ${d ? 'Edici√≥n' : 'Creaci√≥n'}`);

          // 1. GESTI√ìN DE ESTADO REACTIVO
          isEditing.value = !!d; // true si d tiene datos, false si es null

          // 2. L√ìGICA DE NEGOCIO POR TIPO (Preparaci√≥n de datos)
          switch (t) {
            case 'etapa':
              // Validaci√≥n de Integridad Estricta
              if (!selectedTipoConfig.value) {
                Swal.fire('Atenci√≥n', 'Primero selecciona un Tipo de Obra en el men√∫ desplegable.', 'warning');
                return; 
              }
              form.value = d ? { ...d } : { 
                nombre_etapa: '', 
                descripcion: '',
                orden: etapasFiltradasPorTipo.value.length + 1,
                color_hex: '#556B2F',
                id_tipo_proyecto: selectedTipoConfig.value 
              };
              break;

            case 'tipo':
              form.value = d ? { ...d } : { 
                nombre_tipo: '', 
                descripcion: '', 
                color_representativo: '#556B2F' 
              };
              break;

            case 'profesional':
              form.value = d ? { ...d } : { 
                nombre_completo: '', 
                rol: '', 
                especialidad: '', 
                email: '', 
                telefono: '', 
                costo_hora: 0,
                perfil_sistema:'Operador',
                estado: 'Activo' 
              };
              break;

            case 'checklist':
              let items = [];
              if (d && d.config_json) {
                items = parseJson(d.config_json); // Aseg√∫rate de tener definida esta helper parseJson
              }
              form.value = d ? { ...d, items } : { nombre_checklist: '', items: [] };

              // Inicializaci√≥n de Sortable (Drag & Drop)
              nextTick(() => {
                const el = document.getElementById('sortable-items');
                if (el) {
                  Sortable.getOrCreateInstance ? Sortable.getOrCreateInstance(el) : null; // Evitar duplicados
                  Sortable.create(el, {
                    animation: 150,
                    handle: '.handle',
                    ghostClass: 'bg-light-olive', // Clase personalizada con #556B2F al 10%
                    onEnd: (evt) => {
                      const item = form.value.items.splice(evt.oldIndex, 1)[0];
                      form.value.items.splice(evt.newIndex, 0, item);
                    }
                  });
                }
              });
              break;

            case 'proyecto':
            const tipoDefault = tipos.value.length > 0 ? tipos.value[0].id : '';
            const etapaInicial = etapas.value.length > 0 ? etapas.value[0].nombre_etapa : '';
            
            originalTypeId.value = d ? d.id_tipo_proyecto : null;

            // Gesti√≥n de Asignaciones (Traceabilidad)
            let asignadosIds = [];
            if (d && d.id) {
              asignadosIds = allAsignaciones.value
                .filter(a => a.id_proyecto === d.id)
                .map(a => a.id_profesional);
            } else if (currentUserProfile.value?.id) {
              asignadosIds.push(currentUserProfile.value.id);
            }

            form.value = d ? { 
              ...d,
              fecha_inicio: toInputDate(d.fecha_inicio),
              fecha_fin: toInputDate(d.fecha_fin),
              asignados: asignadosIds,
              updated_at: d.updated_at || new Date().toISOString() // ‚Üê CAPTURAR TIMESTAMP
            } : { 
              codigo: '', 
              nombre_obra: '', 
              estado: etapaInicial,
              id_tipo_proyecto: tipoDefault,
              asignados: asignadosIds
            };
            break;

            default:
              console.warn(`[GAS Expert] El tipo de modal "${t}" no est√° definido en el switch.`);
          }

          // 3. CONTROL DEL DOM Y BOOTSTRAP 5 (Cero suposiciones)
          const modalId = `modal-${t}`;
          const modalEl = document.getElementById(modalId);

          if (modalEl) {
            // Usamos getOrCreateInstance para mayor estabilidad en WebApps de GAS
            const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
            modalInstance.show();
            
            // Guardamos en el objeto de referencia por si necesitamos cerrarlo program√°ticamente
            modales[t] = modalInstance; 
          } else {
            Swal.fire({
              title: 'Error de Interfaz',
              text: `No se encontr√≥ el elemento DOM: ${modalId}`,
              icon: 'error',
              confirmButtonColor: '#556B2F'
            });
          }
        };

        const getEtapaColor = (n) => {
          const etapa = etapas.value.find(e => e.nombre_etapa === n);
          return etapa && etapa.color_hex ? etapa.color_hex : '#777';
        };
        const formatDate = (d) => d ? new Date(d).toLocaleDateString() : '-';

        // --- RETURN ---
        return {
          isLoggedIn, loading, currentView, userEmail, userInitial,
          config, proyectos, etapas, profesionales, checklists,isAuthorized,
          activeProject, executionTasks, projectStructure, globalProgress,
          allTareas, tareasFiltradas, selectedEtapa,
          form, filterStatus, profesionalesFiltrados, getProjectStageInfo,
          tipos, selectedTipoConfig, etapasFiltradasPorTipo, getProjectTeam, calculateProjectProgress,
          login, logout, navigate,totalPendientes,searchQuery,proyectosFiltradosBuscador,
          saveProyecto, deleteProject, resetProject,originalTypeId, exportReportToPDF,
          openProjectDetail, updateTask, toggleTaskState, openFillChecklist, saveChecklistData,
          selectEtapa, addTareaLocal, removeTareaLocal, saveTareasBatch,getProjectTeam, 
          openModal, saveGeneric, saveDriveUrl, deleteRecord, getProjectTypeInfo,isModalItemsEmpty,
          getEtapaColor, formatDate, toggleStatus, formatCurrency,allAsignaciones, currentUserProfile,
          parseJson, addChecklistItem, saveChecklist, hasChecklistData, triggerFileUpload, handleFileUpload, 
          hasValidEvidence, getChecklistCount, tareasFiltradasLength,isSidebarCollapsed,toggleSidebar,
          reportData, reportTipos, reportProfesionales, showFilters, reportFilters, reportSort, reportProyectosFiltrados,
          reportTotalTareas, reportTareasCompletadas, reportAvancePromedio,
          loadReportData, toggleFilters, resetReportFilters, reportViewMode, ganttScale, ganttColumnWidth, ganttTimeline, getGanttBarStyle,
          setSortField, toggleSortOrder, dashTotalTareas, dashTareasCompletadas, dashAvancePromedio,
          getProyectoTotalTareas, getProyectoTareasCompletadas, currentChecklistTask, showChecklistModal
        };
      }
    }).mount('#app');
  </script>
</body>

</html>